<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vessel Manager & Calculator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* --- GLOBAL & MAIN APP STYLES --- */
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #1e293b; margin: 0; padding: 0; }
        textarea, pre, code { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.3s ease-out; }
        
        /* --- CALCULATOR SPECIFIC STYLES (Ported & Scoped) --- */
        :root {
            --calc-primary: #2563eb; --calc-primary-dark: #1e40af; 
            --calc-secondary: #64748b; --calc-border: #e2e8f0;
            --calc-success: #10b981; --calc-danger: #ef4444; --calc-warning: #f59e0b;
            --calc-bg-card: #ffffff;
            --calc-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --calc-radius: 12px;
        }

        /* Enforce fonts for calculator inputs */
        .calc-wrapper input, .calc-wrapper select, .calc-wrapper button { 
            font-family: 'Inter', sans-serif; 
            font-variant-numeric: slashed-zero tabular-nums; 
        }

        /* Layout Helpers */
        .calc-wrapper { display: flex; gap: 24px; width: 100%; align-items: flex-start; }
        .calc-main { flex: 3; background: var(--calc-bg-card); padding: 30px; border-radius: var(--calc-radius); box-shadow: var(--calc-shadow); border: 1px solid var(--calc-border); min-width: 0; transition: all 0.3s; }
        .calc-sidebar { flex: 1; background: var(--calc-bg-card); padding: 24px; border-radius: var(--calc-radius); box-shadow: var(--calc-shadow); border: 1px solid var(--calc-border); max-height: calc(100vh - 100px); overflow-y: auto; min-width: 280px; display: flex; flex-direction: column; transition: all 0.3s; }
        .calc-sidebar.collapsed { flex: 0; min-width: 0; width: 0; padding: 0; margin: 0; border: 0; opacity: 0; overflow: hidden; }

        /* Global Inputs Area */
        .calc-inputs { background: #f1f5f9; padding: 20px; border-radius: var(--calc-radius); margin-bottom: 24px; display: flex; gap: 24px; align-items: flex-end; flex-wrap: wrap; }
        .calc-input-grp { display: flex; flex-direction: column; flex: 1; }
        .calc-input-grp.narrow { flex: 0 0 120px; }
        .calc-input-grp label { font-size: 11px; font-weight: 700; color: var(--calc-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .calc-input-field { padding: 10px 12px; border: 1px solid var(--calc-border); border-radius: 6px; font-size: 13px; width: 100%; background: white; transition: border 0.2s; outline: none; }
        .calc-input-field:focus { border-color: var(--calc-primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        /* Tabs */
        .calc-tabs { display: flex; gap: 8px; margin-bottom: 24px; padding: 4px; background: #f1f5f9; border-radius: 8px; width: fit-content; }
        .calc-tab-btn { padding: 8px 24px; cursor: pointer; border-radius: 6px; font-size: 13px; font-weight: 600; color: var(--calc-secondary); border: 1px solid transparent; transition: 0.2s; }
        .calc-tab-btn:hover { color: #0f172a; background: rgba(255,255,255,0.5); }
        .calc-tab-btn.active { background: white; color: var(--calc-primary); border-color: var(--calc-border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* Dynamic Sections */
        .complex-section { 
            background: white; border: 1px solid var(--calc-border); padding: 16px; border-radius: 8px; margin-bottom: 12px; 
            display: grid; grid-template-columns: 120px 80px 1fr 1fr 1fr auto; gap: 12px; align-items: end; transition: box-shadow 0.2s;
        }
        .complex-section:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .complex-section.pier-layout { grid-template-columns: 120px 80px 1fr 1fr 1fr 1fr auto; }
        .section-label { font-weight: 700; font-size: 13px; align-self: center; color: var(--calc-secondary); }
        
        /* Items Table */
        .items-header { display: grid; grid-template-columns: 2fr 0.8fr 1fr 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 0 8px; }
        .item-row { display: grid; grid-template-columns: 2fr 0.8fr 1fr 1fr 1fr 1fr auto; gap: 8px; align-items: center; margin-bottom: 6px; padding: 6px 8px; background: #fff; border: 1px solid var(--calc-border); border-radius: 6px; }
        .item-row:hover { border-color: var(--calc-primary); }

        /* Buttons */
        .c-btn { cursor: pointer; padding: 10px 16px; border: none; border-radius: 6px; font-weight: 600; font-size: 13px; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; }
        .c-btn:hover { filter: brightness(105%); transform: translateY(-1px); }
        .c-btn-pri { background-color: var(--calc-primary); color: white; }
        .c-btn-suc { background-color: var(--calc-success); color: white; }
        .c-btn-warn { background-color: var(--calc-warning); color: white; }
        .c-btn-dang { background-color: var(--calc-danger); color: white; }
        .c-btn-info { background-color: #0ea5e9; color: white; }
        .c-btn-sec { background-color: white; border: 1px solid var(--calc-border); color: #0f172a; }
        .c-btn-sec:hover { background-color: #f8fafc; }
        .c-btn-sm { padding: 4px 8px; font-size: 11px; }
        .c-btn-icon { width: 28px; height: 28px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* Report Styles */
        .xl-wrapper { margin-top: 30px; }
        .xl-info-box { background: #f8fafc; border: 1px solid var(--calc-border); padding: 12px 20px; margin-bottom: 20px; border-radius: 6px; font-size: 13px; color: var(--calc-secondary); display: flex; gap: 20px; }
        .xl-info-box strong { color: #0f172a; }
        .report-card { background: white; border: 1px solid var(--calc-border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; height: 100%; }
        .table-title { font-weight: 700; margin-bottom: 10px; padding-left: 4px; text-transform: uppercase; font-size: 13px; letter-spacing: 0.5px; color: #0f172a; }
        .table-wrapper { flex: 1; display: flex; flex-direction: column; }
        .xl-table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
        .xl-header { background: #f1f5f9; color: var(--calc-secondary); font-weight: 600; text-align: left; padding: 12px 16px; border-bottom: 1px solid var(--calc-border); text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; }
        .xl-row td { padding: 10px 16px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; color: #334155; word-wrap: break-word; }
        .xl-row:nth-child(even) { background-color: #fafafa; }
        .col-amt { text-align: right; padding-right: 24px; font-family: 'Inter', sans-serif; font-weight: 600; font-variant-numeric: slashed-zero tabular-nums; color: #0f172a; }
        .min-highlight { font-weight: 800; color: #0f172a; font-size: 11px; }
        .calc-subtext { display: block; font-size: 11px; color: #64748b; margin-top: 3px; font-weight: 500; }
        .footer-container { margin-top: auto; border-top: 1px solid var(--calc-border); }
        .footer-section { padding: 12px 16px; }
        .footer-section.totals { background: #f8fafc; }
        .footer-section.diffs { background: #fff; border-top: 1px dashed var(--calc-border); color: #b45309; }
        .stat-line { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; padding-bottom: 2px; }
        .stat-val { font-weight: 700; font-variant-numeric: slashed-zero tabular-nums; }
        .comparison-container { display: flex; gap: 20px; }
        .comparison-col { flex: 1; display: flex; flex-direction: column; }
        
        /* History Sidebar Cards */
        .history-card { background: white; border: 1px solid var(--calc-border); border-left: 3px solid var(--calc-primary); padding: 12px; margin-bottom: 10px; border-radius: 6px; cursor: pointer; position: relative; transition: 0.2s; }
        .history-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .history-ref { font-weight: 600; color: var(--calc-primary); font-size: 14px; display: block; margin-bottom: 4px; }
        .history-meta { font-size: 11px; color: var(--calc-secondary); margin-bottom: 8px; }
        
        @media (max-width: 900px) { 
            .calc-wrapper, .comparison-container { flex-direction: column; } 
            .calc-main, .calc-sidebar { width: 100%; }
            .complex-section, .item-row { grid-template-columns: 1fr 1fr; }
            .complex-section .section-label { grid-column: 1 / -1; width: 100%; justify-content: flex-start; }
            .calc-inputs { gap: 15px; }
        }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <div id="root"></div>

    <!-- Firebase Initialization -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURATION
        const firebaseConfig = {
          apiKey: "AIzaSyCChjLWOazjQzLp6JSvdFw3ocWb097Qqlc",
          authDomain: "vsltrker.firebaseapp.com",
          projectId: "vsltrker",
          storageBucket: "vsltrker.firebasestorage.app",
          messagingSenderId: "623033107164",
          appId: "1:623033107164:web:fa7ccf7325346e58536a19",
          measurementId: "G-LNYMSYRWP8"
        };

        const appId = 'vessel-schedule-app'; 

        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);

                window.db = db;
                window.auth = auth;
                window.googleProvider = new GoogleAuthProvider();
                window.signInWithPopup = signInWithPopup;
                window.signOut = signOut;
                window.signInAnonymously = signInAnonymously;
                window.collection = collection;
                window.addDoc = addDoc;
                window.updateDoc = updateDoc;
                window.deleteDoc = deleteDoc;
                window.doc = doc;
                window.getDoc = getDoc;
                window.onSnapshot = onSnapshot;
                window.appId = appId;
                window.onAuthStateChanged = onAuthStateChanged;
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useReducer } = React;

        // --- ICONS ---
        const IconWrapper = ({ children, size = 20, className = "", onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick}>{children}</svg>
        );
        const Icons = {
            Plus: (props) => <IconWrapper {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>,
            Trash2: (props) => <IconWrapper {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>,
            Edit: (props) => <IconWrapper {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconWrapper>,
            Clipboard: (props) => <IconWrapper {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></IconWrapper>,
            Settings: (props) => <IconWrapper {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>,
            Ship: (props) => <IconWrapper {...props}><path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M19.38 20A11.6 11.6 0 0 0 21 14l-9-4-9 4c0 2.9.9 5.8 2.38 8"/><path d="M12 10V4"/><path d="M8 8v1"/><path d="M16 8v1"/></IconWrapper>,
            Calendar: (props) => <IconWrapper {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconWrapper>,
            LayoutList: (props) => <IconWrapper {...props}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/><path d="M14 4h7"/><path d="M14 9h7"/><path d="M14 15h7"/><path d="M14 20h7"/></IconWrapper>,
            Table: (props) => <IconWrapper {...props}><path d="M12 3v18"/><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/></IconWrapper>,
            MapPin: (props) => <IconWrapper {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconWrapper>,
            ChevronLeft: (props) => <IconWrapper {...props}><path d="m15 18-6-6 6-6"/></IconWrapper>,
            ChevronRight: (props) => <IconWrapper {...props}><path d="m9 18 6-6-6-6"/></IconWrapper>,
            Info: (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconWrapper>,
            CheckCircle: (props) => <IconWrapper {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconWrapper>,
            Lock: (props) => <IconWrapper {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconWrapper>,
            Unlock: (props) => <IconWrapper {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></IconWrapper>,
            X: (props) => <IconWrapper {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>,
            Search: (props) => <IconWrapper {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconWrapper>,
            Google: (props) => <IconWrapper {...props}><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2c2.4 0 4.6 0.9 6.3 2.4l-3 2.9C14.2 6.6 13.2 6 12 6c-3.3 0-6 2.7-6 6s2.7 6 6 6c2.9 0 5.3-2 5.9-4.8H12V10.2h10c0.1 0.6 0.2 1.2 0.2 1.8 0 5.6-4.6 10-10.2 10z"/></IconWrapper>,
            User: (props) => <IconWrapper {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconWrapper>,
            Calculator: (props) => <IconWrapper {...props}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconWrapper>,
            Save: (props) => <IconWrapper {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>,
            Download: (props) => <IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconWrapper>,
            Scroll: (props) => <IconWrapper {...props}><path d="M8 19h8a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2z"/><path d="M12 11v4"/><path d="M8 7h8"/></IconWrapper>,
            Refresh: (props) => <IconWrapper {...props}><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></IconWrapper>,
        };

        // --- SHARED COMPONENTS ---
        const InputField = ({ label, name, type = "text", placeholder, value, onChange, required = false, className = "" }) => (
            <div className={`flex flex-col ${className}`}>
                <label className="text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">{label}</label>
                <input type={type} name={name} value={value} onChange={onChange} placeholder={placeholder} required={required} className="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-slate-800 text-sm transition-all shadow-sm" />
            </div>
        );

        const SmartDateInput = ({ label, name, value, onChange, placeholder = "DD/MM/YY", required = false, className = "" }) => {
            const [displayValue, setDisplayValue] = useState('');
            const [error, setError] = useState(false);
            useEffect(() => {
                if (value) { const [y, m, d] = value.split('-'); if (y && m && d) setDisplayValue(`${d}/${m}/${y.slice(-2)}`); } else setDisplayValue(''); setError(false);
            }, [value]);
            const parseAndSubmit = (inputVal) => {
                if (!inputVal.trim()) { onChange({ target: { name, value: '' } }); return; }
                let d, m, y;
                const clean = inputVal.replace(/[^0-9]/g, ' ').trim().split(/\s+/);
                if (clean.length === 1 && clean[0].length === 6) { d = clean[0].substring(0, 2); m = clean[0].substring(2, 4); y = clean[0].substring(4, 6); } 
                else if (clean.length === 3) { [d, m, y] = clean; }
                if (d && m && y) {
                    let numY = parseInt(y, 10); let numM = parseInt(m, 10); let numD = parseInt(d, 10);
                    if (numY < 100) numY += 2000;
                    const dateObj = new Date(numY, numM - 1, numD);
                    if (dateObj.getFullYear() === numY && dateObj.getMonth() === numM - 1 && dateObj.getDate() === numD) {
                        const localIsoDate = `${numY}-${String(numM).padStart(2, '0')}-${String(numD).padStart(2, '0')}`;
                        onChange({ target: { name, value: localIsoDate } });
                        setDisplayValue(`${numD.toString().padStart(2, '0')}/${numM.toString().padStart(2, '0')}/${numY.toString().slice(-2)}`);
                        setError(false); return;
                    }
                }
                setError(true);
            };
            return (
                <div className={`flex flex-col ${className}`}>
                    <label className="text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide flex justify-between">{label}{error && <span className="text-rose-500 normal-case text-[10px] font-medium animate-pulse">Invalid</span>}</label>
                    <div className="relative group">
                        <input type="text" name={name} value={displayValue} onChange={(e) => setDisplayValue(e.target.value)} onBlur={() => parseAndSubmit(displayValue)} onKeyDown={(e) => e.key === 'Enter' && parseAndSubmit(displayValue)} placeholder={placeholder} required={required} className={`w-full px-3 py-2 bg-white border rounded-lg focus:outline-none focus:ring-2 focus:bg-white text-slate-800 text-sm transition-all shadow-sm ${error ? 'border-rose-300 ring-rose-100 focus:ring-rose-200' : 'border-slate-200 focus:ring-blue-500 focus:border-blue-500'}`} />
                        <div className="absolute right-3 top-2.5 pointer-events-none text-slate-400 group-hover:text-blue-500 transition-colors"><Icons.Calendar size={14} /></div>
                    </div>
                </div>
            );
        };

        const CalendarWidget = ({ entry, isAdmin }) => { 
            const [currentDate, setCurrentDate] = useState(new Date());
            useEffect(() => { if (entry) { const initialDateStr = entry.cfsClosing || entry.loadingDate || entry.etdHkg || entry.etaDest; if (initialDateStr) { const [y,m,d] = initialDateStr.split('-').map(Number); setCurrentDate(new Date(y, m-1, d)); } } }, [entry]);
            if (!entry) return <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-12 text-center text-slate-400 flex flex-col items-center gap-4"><div className="opacity-20"><Icons.Calendar size={48} /></div><p>Select a vessel to view calendar.</p></div>;
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
            const changeMonth = (offset) => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1));
            const events = [
                { type: 'CFS', date: entry.cfsClosing, color: 'bg-rose-100 text-rose-700 border-rose-200' },
                ...(isAdmin ? [{ type: 'LOAD', date: entry.loadingDate, color: 'bg-amber-100 text-amber-700 border-amber-200' }] : []),
                { type: 'ETD', date: entry.etdHkg, color: 'bg-blue-100 text-blue-700 border-blue-200' },
                { type: 'ETA', date: entry.etaDest, color: 'bg-emerald-100 text-emerald-700 border-emerald-200' }
            ].filter(e => e.date);
            const days = [];
            for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} className="h-24 bg-slate-50/50 border-r border-b border-slate-100"></div>);
            for (let d = 1; d <= daysInMonth; d++) {
                const dayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), d);
                const currentDayStr = `${dayDate.getFullYear()}-${String(dayDate.getMonth()+1).padStart(2,'0')}-${String(dayDate.getDate()).padStart(2,'0')}`;
                const dayEvents = events.filter(e => e.date === currentDayStr);
                days.push(
                    <div key={d} className="h-24 border-r border-b border-slate-100 p-1 relative hover:bg-slate-50 transition-colors group bg-white">
                        <span className={`text-xs font-semibold p-1.5 rounded-full inline-block w-6 h-6 text-center leading-3 ${dayEvents.length > 0 ? 'bg-slate-800 text-white shadow-sm' : 'text-slate-400'}`}>{d}</span>
                        <div className="flex flex-col gap-1 mt-1">{dayEvents.map((ev, idx) => <div key={idx} className={`text-[10px] px-1.5 py-0.5 rounded border ${ev.color} font-bold shadow-sm truncate`}>{ev.type}</div>)}</div>
                    </div>
                );
            }
            return (
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="p-4 border-b border-slate-200 flex items-center justify-between bg-slate-50/50">
                        <div className="flex items-center gap-3"><div className="bg-gradient-to-br from-blue-600 to-indigo-700 p-2.5 rounded-xl text-white shadow-md"><Icons.Calendar size={20} /></div><div><h3 className="font-bold text-slate-800">{entry.vessel}</h3><p className="text-xs text-slate-500 font-medium">Logistics Timeline</p></div></div>
                        <div className="flex items-center bg-white rounded-lg border border-slate-200 shadow-sm">
                            <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-slate-50 text-slate-600 rounded-l-lg transition-colors"><Icons.ChevronLeft size={16} /></button>
                            <span className="px-4 text-sm font-semibold min-w-[140px] text-center text-slate-700">{currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })}</span>
                            <button onClick={() => changeMonth(1)} className="p-2 hover:bg-slate-50 text-slate-600 rounded-r-lg transition-colors"><Icons.ChevronRight size={16} /></button>
                        </div>
                    </div>
                    <div className="grid grid-cols-7 bg-slate-50 text-[10px] font-bold text-slate-400 text-center py-2.5 border-b border-slate-200 uppercase tracking-widest"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
                    <div className="grid grid-cols-7 bg-white">{days}</div>
                </div>
            );
        };

        // --- CALCULATOR LOGIC (Pure JS) ---
        const CURRENCIES = ['EUR', 'USD', 'HKD', 'RMB'];
        const DEFAULT_PRESETS = {
            "SEA MASTER STANDARD - NON DG": { "sections": [{ "type": "lcl", "data": { "rt": 15, "ton": 30, "min": 30, "curr": "EUR" } }, { "type": "pier", "data": { "high": 13.4, "heavy": 66.69, "light": 83.74, "min": 74.4, "curr": "EUR" } }, { "type": "stor", "data": { "rate": 0, "min_days": 0, "days": 0, "curr": "EUR", "unit": "RT" } }], "items": [{ "name": "GSC", "price": 5.5, "unit": "RT", "curr": "EUR", "min_type": "None", "min_val": 0 }, { "name": "ERS", "price": 24, "unit": "RT", "curr": "EUR", "min_type": "None", "min_val": 0 }, { "name": "ATB FEE", "price": 10.5, "unit": "BL", "curr": "EUR", "min_type": "None", "min_val": 0 }, { "name": "EECS", "price": 3.5, "unit": "BL", "curr": "EUR", "min_type": "None", "min_val": 0 }, { "name": "DO", "price": 65, "unit": "BL", "curr": "EUR", "min_type": "None", "min_val": 0 }, { "name": "ANTI TERROR", "price": 5.5, "unit": "BL", "curr": "EUR", "min_type": "None", "min_val": 0 }, { "name": "SECURE RELEASE", "price": 7, "unit": "BL", "curr": "EUR", "min_type": "None", "min_val": 0 }], "title": "SEA MASTER STANDARD - NON DG" },
            "EMPTY": { "sections": [{ "type": "lcl", "data": { "rt": 0, "ton": 0, "min": 0, "curr": "EUR" } }, { "type": "pier", "data": { "high": 0, "heavy": 0, "light": 0, "min": 0, "curr": "EUR" } }, { "type": "stor", "data": { "rate": 0, "min_days": 0, "days": 0, "curr": "EUR", "unit": "RT" } }], "items": [], "title": "Empty Template" }
        };

        function calculateCharges(cbm, kgs, pkgs, sections, extra_items) {
            let rt = Math.max(cbm, kgs / 1000.0);
            let tons = kgs / 1000.0;
            let avg_pkg_weight = (pkgs > 0) ? (kgs / pkgs) : 0;
            let rows = [];

            if(!sections) sections = [];
            if(!extra_items) extra_items = [];

            sections.forEach(section => {
                let d = section.data;
                let s_curr = d.curr || 'EUR';

                if (section.type === 'lcl') {
                    let calc_cbm = d.rt * cbm; 
                    let calc_ton = d.ton * tons;
                    let base_calc = Math.max(calc_cbm, calc_ton);
                    let lcl_min = d.min || 0.0;
                    let lcl_total = 0;
                    let desc_line2 = "";

                    if (base_calc < lcl_min) {
                        lcl_total = lcl_min;
                        desc_line2 = `<span class="min-highlight">[APPLIED: MINIMUM (${lcl_min.toFixed(2)})]</span>`;
                    } else {
                        lcl_total = base_calc;
                        desc_line2 = calc_cbm >= calc_ton ? `<span class="min-highlight">[APPLIED: CBM RATE]</span>` : `<span class="min-highlight">[APPLIED: TON RATE]</span>`;
                    }
                    rows.push({'item': 'LCL CHARGES', 'desc': `${s_curr} ${d.rt}/CBM OR ${d.ton}/TON | MIN ${lcl_min.toFixed(2)} ${desc_line2}`, 'curr': s_curr, 'amount': lcl_total});
                }
                else if (section.type === 'pier') {
                    let effective_tons = Math.max(tons, 1.0);
                    let rate_weight = (avg_pkg_weight > 20) ? d.heavy : d.light;
                    let amt_weight = rate_weight * effective_tons;
                    let amt_high = (rt > 5 && (tons > 0 ? (cbm/tons) : 0) >= 5) ? (d.high * rt) : 0.0;
                    let calculated_amt = Math.max(amt_high, amt_weight);
                    let pier_total = 0.0;
                    let desc_line2 = "";

                    if (calculated_amt < d.min) {
                        pier_total = d.min;
                        desc_line2 = `<span class="min-highlight">[APPLIED: MINIMUM (${d.min.toFixed(2)})]</span>`;
                    } else {
                        pier_total = calculated_amt;
                        desc_line2 = amt_high > amt_weight ? `<span class="min-highlight">[APPLIED: HIGH VOL RATE]</span>` : (avg_pkg_weight > 20 ? `<span class="min-highlight">[APPLIED: HEAVY RATE]</span>` : `<span class="min-highlight">[APPLIED: LIGHT RATE]</span>`);
                    }
                    rows.push({'item': 'PIER CHARGES', 'desc': `${s_curr} ${d.heavy}/TON (>20kg) | ${d.light}/TON (<20kg) | ${d.high}/RT (Ratio â‰¥5) | MIN ${d.min.toFixed(2)} ${desc_line2}`, 'curr': s_curr, 'amount': pier_total});
                }
                else if (section.type === 'stor') {
                    let s_rate = d.rate;
                    let s_min_days = parseInt(d.min_days);
                    let s_unit = d.unit || 'RT';
                    let actual_days = d.days || 0;
                    if (s_rate > 0 && actual_days > 0) {
                        let billable_days = Math.max(actual_days, s_min_days);
                        let qty_used = s_unit === 'RT' ? rt : s_unit === 'CBM' ? cbm : s_unit === 'TON' ? tons : s_unit === 'PKG' ? pkgs : s_unit === 'FLAT' ? 1.0 : rt;
                        let stor_amt = s_rate * qty_used * billable_days;
                        let min_text = actual_days < s_min_days ? `<span class="min-highlight">[APPLIED: MINIMUM (${s_min_days} DAYS)]</span>` : `<span class="min-highlight">[APPLIED: ${actual_days} DAYS]</span>`;
                        rows.push({'item': 'STORAGE', 'desc': `${s_curr} ${s_rate}/${s_unit}/DAY ${min_text}`, 'curr': s_curr, 'amount': stor_amt});
                    }
                }
            });

            extra_items.forEach(item => {
                let price = item.price;
                let unit = item.unit;
                let curr = item.curr;
                let min_type = item.min_type || 'None';
                let min_val = item.min_val || 0.0;
                
                let qty_used = 0.0;
                if (['FLAT', 'SHPT', 'BL'].includes(unit)) qty_used = 1.0;
                else if (['RT', 'W/M'].includes(unit)) qty_used = rt;
                else if (unit === 'CBM') qty_used = cbm;
                else if (unit === 'TON') qty_used = tons;
                else if (unit === 'PKG') qty_used = pkgs;
                
                let billable_qty = ['RT', 'W/M', 'CBM', 'TON'].includes(unit) ? Math.max(qty_used, 1.0) : qty_used;
                if (min_type === 'Unit' && ['RT', 'W/M', 'CBM', 'TON'].includes(unit)) billable_qty = Math.max(billable_qty, min_val);

                let line_total = price * billable_qty;
                let amt_min_applied = false;
                if (min_type === 'Amt' && min_val > line_total) { line_total = min_val; amt_min_applied = true; }

                let desc = `${curr} ${price}/${unit}`;
                if (min_type === 'Amt') desc += ` | MIN ${curr} ${min_val.toFixed(2)}`;
                else if (min_type === 'Unit' && min_val > 1) desc += ` | MIN ${min_val} ${unit}`;

                let min_text = "";
                if (amt_min_applied) min_text = `[APPLIED: MINIMUM (${min_val.toFixed(2)})]`;
                else if (min_type === 'Unit' && billable_qty === min_val && billable_qty > qty_used) min_text = `[APPLIED: MINIMUM (${min_val} ${unit})]`;

                if(min_text) desc += ` <span class="calc-subtext"><span class="min-highlight">${min_text}</span></span>`;

                if (line_total > 0) rows.push({'item': item.name.toUpperCase(), 'desc': desc, 'curr': curr, 'amount': line_total});
            });

            rows.sort((a, b) => a.curr.localeCompare(b.curr));
            
            let totals = {};
            CURRENCIES.forEach(c => totals[c] = 0.0);
            rows.forEach(r => { if (totals[r.curr] !== undefined) totals[r.curr] += r.amount; });

            return { rows: rows, totals: totals, meta: {cbm, kgs, pkgs} };
        }

        function generateReportHTML(res_std, res_req, view_mode, title_std, title_req) {
            let active_currencies = CURRENCIES.filter(c => res_std.totals[c] > 0 || res_req.totals[c] > 0);
            let meta = res_std.meta;
            let cargo_html = `<div class="xl-info-box"><strong>SHIPMENT DETAILS:</strong>&nbsp;&nbsp; CBM: ${meta.cbm.toFixed(3)} &nbsp;|&nbsp; KGS: ${meta.kgs.toFixed(3)} &nbsp;|&nbsp; PKGS: ${meta.pkgs}</div>`;

            let rows_std = [...res_std.rows];
            let rows_req = [...res_req.rows];

            if (view_mode === 'Comparison') {
                let max_len = Math.max(rows_std.length, rows_req.length);
                while (rows_std.length < max_len) rows_std.push({ is_pad: true });
                while (rows_req.length < max_len) rows_req.push({ is_pad: true });
            }

            const buildColumnHTML = (rows, totals, title, show_diff) => {
                let rows_html = rows.map(r => {
                    if (r.is_pad) return `<tr class="xl-row"><td>&nbsp;</td><td></td><td></td><td></td></tr>`;
                    return `<tr class="xl-row"><td class="col-item">${r.item}</td><td class="col-desc">${r.desc}</td><td class="col-curr">${r.curr}</td><td class="col-amt">${r.amount.toFixed(2)}</td></tr>`;
                }).join('');

                let footer_html = `<div class="footer-section totals">`;
                if (active_currencies.length > 0) {
                    active_currencies.forEach(c => {
                        if (totals[c] > 0 || show_diff || view_mode === 'Comparison') footer_html += `<div class="stat-line"><span class="stat-lbl">TOTAL ${c}</span> <span class="stat-val">${(totals[c]||0).toFixed(2)}</span></div>`;
                    });
                } else footer_html += `<div class="stat-line"><span class="stat-lbl">TOTAL</span> <span class="stat-val">0.00</span></div>`;
                footer_html += `</div>`;

                let diff_content = "";
                if (active_currencies.length > 0) {
                    active_currencies.forEach(c => {
                        let diff = (res_std.totals[c] || 0) - (res_req.totals[c] || 0);
                        let sign = diff >= 0 ? "+" : "";
                        diff_content += `<div class="stat-line"><span class="stat-lbl">DIFF ${c}</span> <span class="stat-val">${sign}${diff.toFixed(2)}</span></div>`;
                    });
                } else {
                     diff_content += `<div class="stat-line"><span class="stat-lbl">DIFF</span> <span class="stat-val">0.00</span></div>`;
                }

                let diff_html = "";
                if (view_mode === 'Comparison') {
                    // In comparison, always render to reserve space, hide if not showing diff
                    diff_html = `<div class="footer-section diffs" style="${show_diff ? '' : 'visibility: hidden;'}">${diff_content}</div>`;
                } else if (show_diff) {
                    diff_html = `<div class="footer-section diffs">${diff_content}</div>`;
                }

                return `<div class="report-card">
                            <div class="table-title">${title}</div>
                            <div class="table-wrapper">
                                <table class="xl-table">
                                    <thead><tr><th class="xl-header col-item">Item</th><th class="xl-header col-desc">Description</th><th class="xl-header col-curr">Cur</th><th class="xl-header col-amt">Amount</th></tr></thead>
                                    <tbody>${rows_html}</tbody>
                                </table>
                            </div>
                            <div class="footer-container">${footer_html}${diff_html}</div>
                        </div>`;
            };

            let left = (view_mode !== 'Requested') ? buildColumnHTML(rows_std, res_std.totals, title_std, false) : "";
            let right = (view_mode !== 'Standard') ? buildColumnHTML(rows_req, res_req.totals, title_req, view_mode === 'Comparison') : "";

            let container_html = "";
            if (view_mode === 'Comparison') {
                container_html = `<div class="comparison-container"><div class="comparison-col">${left}</div><div class="comparison-col">${right}</div></div>`;
            } else {
                container_html = `<div style="width:100%;">${left || right}</div>`;
            }

            return `<div class='xl-wrapper'>${cargo_html}${container_html}</div>`;
        }

        // --- CALCULATOR COMPONENT ---
        const DestCalcTool = () => {
            const [globals, setGlobals] = useState({ ref: '', cbm: 3.0, kgs: 250, pkgs: 3, viewMode: 'Comparison' });
            const [stdData, setStdData] = useState({ sections: [], items: [], title: '' });
            const [reqData, setReqData] = useState({ sections: [], items: [], title: '' });
            const [mgrData, setMgrData] = useState({ sections: [], items: [], title: '' });
            const [presets, setPresets] = useState(DEFAULT_PRESETS);
            const [history, setHistory] = useState([]);
            const [activeSubTab, setActiveSubTab] = useState('std');
            const [htmlOutput, setHtmlOutput] = useState('');
            const [selectedPresetName, setSelectedPresetName] = useState('Create New...');
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
            const [showAdvanced, setShowAdvanced] = useState(false);

            useEffect(() => {
                const saved = localStorage.getItem('dest_calc_v1');
                if (saved) {
                    const d = JSON.parse(saved);
                    setGlobals(d.globals || { ref: '', cbm: 3, kgs: 250, pkgs: 3, viewMode: 'Comparison' });
                    setStdData(d.std || { sections: [], items: [], title: 'Standard' });
                    setReqData(d.req || { sections: [], items: [], title: 'Requested' });
                    setPresets({ ...DEFAULT_PRESETS, ...(d.presets || {}) });
                    setHistory(d.history || []);
                } else {
                    setStdData(JSON.parse(JSON.stringify(DEFAULT_PRESETS["SEA MASTER STANDARD - NON DG"])));
                    setReqData({ sections: [], items: [], title: 'Requested Charges' });
                }
            }, []);

            useEffect(() => {
                 setTimeout(() => {
                    const resStd = calculateCharges(parseFloat(globals.cbm), parseFloat(globals.kgs), parseInt(globals.pkgs), stdData.sections, stdData.items);
                    const resReq = calculateCharges(parseFloat(globals.cbm), parseFloat(globals.kgs), parseInt(globals.pkgs), reqData.sections, reqData.items);
                    setHtmlOutput(generateReportHTML(resStd, resReq, globals.viewMode, stdData.title, reqData.title));
                    localStorage.setItem('dest_calc_v1', JSON.stringify({ globals, std: stdData, req: reqData, presets, history }));
                 }, 50);
            }, [globals, stdData, reqData, presets, history]);

            const getTargetData = (target) => (target === 'std' ? stdData : target === 'req' ? reqData : mgrData);
            const setTargetData = (target, newData) => {
                if (target === 'std') setStdData(newData);
                else if (target === 'req') setReqData(newData);
                else setMgrData(newData);
            };

            const updateSection = (target, idx, field, val) => {
                const prev = getTargetData(target);
                const newData = { ...prev, sections: [...prev.sections] };
                newData.sections[idx] = { ...newData.sections[idx], data: { ...newData.sections[idx].data, [field]: parseFloat(val) || val } };
                setTargetData(target, newData);
            };

            const addSection = (target) => {
                const type = document.getElementById(`${target}-add-type`).value;
                const prev = getTargetData(target);
                const newSec = { type, data: { curr: 'EUR', rt: 0, ton: 0, min: 0, heavy: 0, light: 0, high: 0, rate: 0, min_days: 0, days: 0, unit: 'RT' } };
                setTargetData(target, { ...prev, sections: [...prev.sections, newSec] });
            };

            const removeSection = (target, idx) => {
                const prev = getTargetData(target);
                setTargetData(target, { ...prev, sections: prev.sections.filter((_, i) => i !== idx) });
            };

            const updateItem = (target, idx, field, val) => {
                const prev = getTargetData(target);
                const newItems = [...prev.items];
                newItems[idx] = { ...newItems[idx], [field]: (field === 'price' || field === 'min_val') ? parseFloat(val) : val };
                setTargetData(target, { ...prev, items: newItems });
            };

            const addItem = (target) => {
                const prev = getTargetData(target);
                setTargetData(target, { ...prev, items: [...prev.items, { name: '', price: 0, unit: 'FLAT', curr: 'EUR', min_type: 'None', min_val: 0 }] });
            };

            const removeItem = (target, idx) => {
                const prev = getTargetData(target);
                setTargetData(target, { ...prev, items: prev.items.filter((_, i) => i !== idx) });
            };

            const loadPreset = (target, presetName) => {
                if(presets[presetName]) setTargetData(target, JSON.parse(JSON.stringify(presets[presetName])));
            };

            const handleMgrSelect = (val) => {
                setSelectedPresetName(val);
                if (val === 'Create New...') setMgrData({ sections: [], items: [], title: '' });
                else if (presets[val]) setMgrData(JSON.parse(JSON.stringify(presets[val])));
            };

            const handleSavePreset = () => {
                const name = mgrData.title.trim() || document.getElementById('mgr-name-input').value;
                if(!name) return alert("Please enter a Preset Name.");
                setPresets(prev => ({ ...prev, [name]: mgrData }));
                setSelectedPresetName(name);
                alert(`Preset "${name}" saved.`);
            };

            const handleDeletePreset = () => {
                if(selectedPresetName === 'Create New...' || !presets[selectedPresetName]) return;
                if(!confirm(`Delete preset "${selectedPresetName}"?`)) return;
                const newPresets = { ...presets };
                delete newPresets[selectedPresetName];
                setPresets(newPresets);
                handleMgrSelect('Create New...');
            };

            const saveSnapshot = () => {
                const resStd = calculateCharges(parseFloat(globals.cbm), parseFloat(globals.kgs), parseInt(globals.pkgs), stdData.sections, stdData.items);
                const resReq = calculateCharges(parseFloat(globals.cbm), parseFloat(globals.kgs), parseInt(globals.pkgs), reqData.sections, reqData.items);
                let summary = {};
                CURRENCIES.forEach(c => { if(resStd.totals[c] > 0 || resReq.totals[c] > 0) summary[c] = { std: resStd.totals[c], diff: resStd.totals[c] - resReq.totals[c] }; });
                const newHist = { id: Date.now(), timestamp: new Date().toLocaleTimeString(), ref: globals.ref || "No Ref", cbm: globals.cbm, summary, snap_std: stdData, snap_req: reqData };
                setHistory([newHist, ...history].slice(0, 50));
            };
            
            const handleImportJSON = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const imported = JSON.parse(evt.target.result);
                        setPresets(prev => ({ ...prev, ...imported }));
                        alert("Presets imported successfully.");
                    } catch (err) { alert("Invalid JSON file."); }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const renderInputs = (target, data) => (
                <div className="space-y-4">
                    {target !== 'mgr' ? (
                        <div className="flex gap-4 mb-4 bg-slate-50 p-3 rounded-lg border border-slate-200">
                             <div className="calc-input-grp"><label>Section Title</label><input className="calc-input-field" value={data.title} onChange={e => setTargetData(target, {...data, title: e.target.value})} style={{fontWeight:600}} /></div>
                        </div>
                    ) : (
                         <div className="bg-amber-50 border border-amber-200 p-4 rounded-lg mb-4 space-y-3">
                            <div className="flex gap-4 items-center">
                                <div className="flex-1"><label className="block text-[10px] font-bold text-amber-700 uppercase mb-1">Select Preset</label><select value={selectedPresetName} onChange={e => handleMgrSelect(e.target.value)} className="w-full text-sm border rounded p-1.5"><option>Create New...</option>{Object.keys(presets).map(k => <option key={k} value={k}>{k}</option>)}</select></div>
                                <div className="flex-1"><label className="block text-[10px] font-bold text-amber-700 uppercase mb-1">Preset Name</label><input id="mgr-name-input" className="w-full text-sm border rounded p-1.5 font-bold" value={data.title} onChange={e => setTargetData(target, {...data, title: e.target.value})} placeholder="e.g. CLIENT A" /></div>
                            </div>
                            <div className="flex gap-2"><button onClick={handleSavePreset} className="c-btn c-btn-suc c-btn-sm">Save Preset</button><button onClick={handleDeletePreset} className="c-btn c-btn-dang c-btn-sm">Delete</button></div>
                        </div>
                    )}
                    <div style={{background:'#f8fafc', padding:12, borderRadius:8, display:'flex', alignItems:'center', gap:12, marginBottom:16, border:'1px solid #e2e8f0'}}>
                         <label style={{fontSize:13, fontWeight:600, color:'#64748b'}}>Add Charge:</label>
                         <select id={`${target}-add-type`} style={{flexGrow:1, padding:6, borderRadius:4, border:'1px solid #cbd5e1'}}><option value="lcl">LCL (Weight/Measure)</option><option value="pier">Pier (Lifting)</option><option value="stor">Storage (Time)</option></select>
                         <button className="c-btn c-btn-info c-btn-sm" onClick={() => addSection(target)}>+ Add Section</button>
                    </div>

                    {data.sections.map((sec, idx) => (
                        <div key={idx} className={`complex-section ${sec.type === 'pier' ? 'pier-layout' : ''}`}>
                            <div className="section-label">{sec.type.toUpperCase()}</div>
                            <div className="calc-input-grp"><label>CUR</label><select className="calc-input-field" value={sec.data.curr} onChange={e => updateSection(target, idx, 'curr', e.target.value)}>{CURRENCIES.map(c => <option key={c}>{c}</option>)}</select></div>
                            {sec.type === 'lcl' && <><div className="calc-input-grp"><label>CBM RATE</label><input type="number" className="calc-input-field" value={sec.data.rt} onChange={e => updateSection(target, idx, 'rt', e.target.value)} /></div><div className="calc-input-grp"><label>TON RATE</label><input type="number" className="calc-input-field" value={sec.data.ton} onChange={e => updateSection(target, idx, 'ton', e.target.value)} /></div><div className="calc-input-grp"><label>MIN AMT</label><input type="number" className="calc-input-field" value={sec.data.min} onChange={e => updateSection(target, idx, 'min', e.target.value)} /></div></>}
                            {sec.type === 'pier' && <><div className="calc-input-grp"><label>&gt;20KG</label><input type="number" className="calc-input-field" value={sec.data.heavy} onChange={e => updateSection(target, idx, 'heavy', e.target.value)} /></div><div className="calc-input-grp"><label>&lt;20KG</label><input type="number" className="calc-input-field" value={sec.data.light} onChange={e => updateSection(target, idx, 'light', e.target.value)} /></div><div className="calc-input-grp"><label>HIGH VOL</label><input type="number" className="calc-input-field" value={sec.data.high} onChange={e => updateSection(target, idx, 'high', e.target.value)} /></div><div className="calc-input-grp"><label>MIN</label><input type="number" className="calc-input-field" value={sec.data.min} onChange={e => updateSection(target, idx, 'min', e.target.value)} /></div></>}
                            {sec.type === 'stor' && <><div className="calc-input-grp"><label>RATE</label><input type="number" className="calc-input-field" value={sec.data.rate} onChange={e => updateSection(target, idx, 'rate', e.target.value)} /></div><div className="calc-input-grp"><label>UNIT</label><select className="calc-input-field" value={sec.data.unit} onChange={e => updateSection(target, idx, 'unit', e.target.value)}>{['RT','BL','FLAT','PKG','TON','CBM'].map(u => <option key={u}>{u}</option>)}</select></div><div className="calc-input-grp"><label>MIN DAYS</label><input type="number" className="calc-input-field" value={sec.data.min_days} onChange={e => updateSection(target, idx, 'min_days', e.target.value)} /></div><div className="calc-input-grp"><label>ACT DAYS</label><input type="number" className="calc-input-field" value={sec.data.days} onChange={e => updateSection(target, idx, 'days', e.target.value)} /></div></>}
                            <button className="c-btn c-btn-dang c-btn-icon" onClick={() => removeSection(target, idx)}>Ã—</button>
                        </div>
                    ))}
                    <div style={{margin:'24px 0 8px 0', fontSize:12, fontWeight:700, color:'#64748b', textTransform:'uppercase'}}>Extra Line Items</div>
                    <div className="items-header"><label style={{fontSize:10,fontWeight:700,color:'#94a3b8'}}>NAME</label><label style={{fontSize:10,fontWeight:700,color:'#94a3b8'}}>CUR</label><label style={{fontSize:10,fontWeight:700,color:'#94a3b8'}}>PRICE</label><label style={{fontSize:10,fontWeight:700,color:'#94a3b8'}}>UNIT</label><label style={{fontSize:10,fontWeight:700,color:'#94a3b8'}}>MIN TYPE</label><label style={{fontSize:10,fontWeight:700,color:'#94a3b8'}}>MIN VAL</label><span></span></div>
                    {data.items.map((item, idx) => (
                        <div key={idx} className="item-row">
                            <input className="calc-input-field" placeholder="Desc" value={item.name} onChange={e => updateItem(target, idx, 'name', e.target.value)} />
                            <select className="calc-input-field" value={item.curr} onChange={e => updateItem(target, idx, 'curr', e.target.value)}>{CURRENCIES.map(c => <option key={c}>{c}</option>)}</select>
                            <input type="number" className="calc-input-field" placeholder="0" value={item.price} onChange={e => updateItem(target, idx, 'price', e.target.value)} />
                            <select className="calc-input-field" value={item.unit} onChange={e => updateItem(target, idx, 'unit', e.target.value)}>{['RT','BL','FLAT','PKG','TON','CBM'].map(u => <option key={u}>{u}</option>)}</select>
                            <select className="calc-input-field" value={item.min_type||'None'} onChange={e => updateItem(target, idx, 'min_type', e.target.value)}><option value="None">-</option><option value="Amt">Amt</option><option value="Unit">Unit</option></select>
                            <input type="number" className="calc-input-field" value={item.min_val||0} onChange={e => updateItem(target, idx, 'min_val', e.target.value)} />
                            <button className="c-btn c-btn-dang c-btn-icon" onClick={() => removeItem(target, idx)}>Ã—</button>
                        </div>
                    ))}
                    <button className="c-btn c-btn-sec" style={{width:'100%', marginTop:10, borderStyle:'dashed'}} onClick={() => addItem(target)}>+ Add Line Item</button>
                    {target === 'mgr' && (
                        <div className="mt-6 pt-6 border-t border-slate-200">
                             <div className="flex cursor-pointer text-xs font-bold text-slate-500 items-center gap-1 mb-2" onClick={() => setShowAdvanced(!showAdvanced)}><span>âš™ï¸ Advanced Options</span><span>{showAdvanced ? 'â–¼' : 'â–º'}</span></div>
                             {showAdvanced && (
                                <div className="bg-slate-50 p-4 rounded border border-slate-200 animate-fade">
                                     <div className="flex gap-2">
                                         <button onClick={() => {const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(presets,null,2)],{type:"application/json"}));a.download="presets.json";a.click();}} className="c-btn c-btn-info c-btn-sm">Export JSON</button>
                                         <label className="c-btn c-btn-sec c-btn-sm cursor-pointer">Import JSON<input type="file" accept=".json" onChange={handleImportJSON} className="hidden" /></label>
                                     </div>
                                </div>
                             )}
                        </div>
                    )}
                </div>
            );

            return (
                <div className="calc-wrapper">
                    <div className="calc-main">
                        <div className="flex justify-between items-center mb-6 border-b border-slate-200 pb-4">
                            <div><h3 className="font-bold text-xl text-slate-800">Destination Charges Calculator</h3><span className="text-xs text-slate-500">Comparison & Generation Tool</span></div>
                            <div className="flex gap-2">
                                <button className={`c-btn ${sidebarCollapsed ? 'c-btn-pri' : 'c-btn-sec'}`} onClick={() => setSidebarCollapsed(!sidebarCollapsed)}>
                                    {sidebarCollapsed ? <Icons.LayoutList size={16}/> : <Icons.Scroll size={16}/>}
                                    <span className="ml-1">{sidebarCollapsed ? 'Show History' : 'Hide History'}</span>
                                </button>
                            </div>
                        </div>
                        <div className="calc-inputs">
                            <div className="calc-input-grp" style={{flex:2}}><label>Job Reference #</label><input className="calc-input-field" placeholder="e.g. HMB-2023-001" value={globals.ref} onChange={e => setGlobals({...globals, ref: e.target.value})} /></div>
                            <div className="calc-input-grp narrow"><label>CBM (mÂ³)</label><input type="number" className="calc-input-field" value={globals.cbm} onChange={e => setGlobals({...globals, cbm: e.target.value})} /></div>
                            <div className="calc-input-grp narrow"><label>KGS</label><input type="number" className="calc-input-field" value={globals.kgs} onChange={e => setGlobals({...globals, kgs: e.target.value})} /></div>
                            <div className="calc-input-grp narrow"><label>PKGS</label><input type="number" className="calc-input-field" value={globals.pkgs} onChange={e => setGlobals({...globals, pkgs: e.target.value})} /></div>
                            <div className="calc-input-grp" style={{flex:'0 0 auto', paddingBottom:1}}><button className="c-btn c-btn-pri" onClick={saveSnapshot}>ðŸ“¸ Snap</button></div>
                        </div>
                        <div className="calc-tabs">
                            <div onClick={() => setActiveSubTab('std')} className={`calc-tab-btn ${activeSubTab==='std'?'active':''}`}>Standard (Left)</div>
                            <div onClick={() => setActiveSubTab('req')} className={`calc-tab-btn ${activeSubTab==='req'?'active':''}`}>Requested (Right)</div>
                            <div onClick={() => setActiveSubTab('mgr')} className={`calc-tab-btn ${activeSubTab==='mgr'?'active':''}`}>Manage Presets</div>
                        </div>
                        <div className="animate-fade">
                            {activeSubTab !== 'mgr' && (
                                <div className="flex justify-between items-center mb-4">
                                    <div className="flex gap-2 items-center">
                                        <select className="text-xs border rounded p-1" onChange={(e) => loadPreset(activeSubTab, e.target.value)}><option>Load Preset...</option>{Object.keys(presets).map(k => <option key={k} value={k}>{k}</option>)}</select>
                                    </div>
                                </div>
                            )}
                            {activeSubTab === 'std' && renderInputs('std', stdData)}
                            {activeSubTab === 'req' && renderInputs('req', reqData)}
                            {activeSubTab === 'mgr' && renderInputs('mgr', mgrData)}
                        </div>
                        {activeSubTab !== 'mgr' && (
                            <div className="mt-8 pt-6 border-t border-slate-200">
                                <div className="flex justify-center items-center gap-4 mb-6">
                                    <label className="text-sm font-bold text-slate-500">VIEW MODE:</label>
                                    <select value={globals.viewMode} onChange={e => setGlobals({...globals, viewMode: e.target.value})} className="border rounded p-2 text-sm font-bold w-56"><option value="Comparison">Side-by-Side Comparison</option><option value="Standard">Standard Only</option><option value="Requested">Requested Only</option></select>
                                </div>
                                <div dangerouslySetInnerHTML={{__html: htmlOutput}}></div>
                            </div>
                        )}
                    </div>
                    <div className={`calc-sidebar ${sidebarCollapsed ? 'collapsed' : ''}`}>
                        <div className="flex justify-between items-center mb-4"><h4>History</h4><button onClick={() => setHistory([])} className="text-[10px] text-slate-400 hover:text-rose-500">Clear All</button></div>
                        <div className="space-y-2">
                             {history.length === 0 && <div className="text-center text-slate-400 text-xs mt-10">No snapshots yet.</div>}
                             {history.map(h => (
                                <div key={h.id} className="history-card" onClick={() => {setGlobals(p => ({...p, ref: h.ref, cbm: h.cbm})); setStdData(h.snap_std); setReqData(h.snap_req);}}>
                                    <button className="absolute top-2 right-2 text-slate-300 hover:text-rose-500" onClick={(e) => {e.stopPropagation(); setHistory(history.filter(x=>x.id!==h.id));}}>Ã—</button>
                                    <span className="history-ref">{h.ref}</span>
                                    <div className="history-meta">{h.timestamp} | {h.cbm} mÂ³</div>
                                    <div className="text-[10px]">{Object.entries(h.summary).map(([curr, val]) => <div key={curr} className="flex justify-between"><span>{curr} {val.std.toFixed(2)}</span><span className={val.diff>=0?'text-rose-500 font-bold':'text-emerald-500 font-bold'}>{val.diff>=0?'+':''}{val.diff.toFixed(2)}</span></div>)}</div>
                                </div>
                             ))}
                        </div>
                    </div>
                </div>
            );
        };

        const VesselScheduleApp = () => {
            const [entries, setEntries] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isAdmin, setIsAdmin] = useState(false);
            const [user, setUser] = useState(null);
            const [authErrorMsg, setAuthErrorMsg] = useState(null);
            const [activeTab, setActiveTab] = useState('schedule'); 
            const [activeScheduleFilter, setActiveScheduleFilter] = useState('ALL');
            const [selectedEntryId, setSelectedEntryId] = useState(null);
            const [selectedForText, setSelectedForText] = useState(new Set());
            const [selectionDestCode, setSelectionDestCode] = useState(null);
            const [editingId, setEditingId] = useState(null);
            const [adminSearchTerm, setAdminSearchTerm] = useState('');
            const [adminSortBy, setAdminSortBy] = useState('etd'); 
            const formTopRef = useRef(null);
            const [formData, setFormData] = useState({ vessel: '', voyage: '', cfsClosing: '', etdHkg: '', etaDest: '', destCode: 'HAM', loadingDate: '', carrier: '', transitTime: '' });
            const [displayConfig, setDisplayConfig] = useState({ showVesselLine: true, showCarrier: true, showCfs: true, showLoad: true, showEtd: true, showEta: true, showTt: true });
            const [generatedText, setGeneratedText] = useState('');
            const [copied, setCopied] = useState(false);

            useEffect(() => {
                const unsubscribe = window.onAuthStateChanged(window.auth, async (currentUser) => {
                    setUser(currentUser);
                    setAuthErrorMsg(null);
                    if (currentUser) {
                        if (currentUser.isAnonymous) {
                            setIsAdmin(false); setActiveTab('schedule');
                        } else {
                            try {
                                const configRef = window.doc(window.db, 'config', 'admin');
                                const configSnap = await window.getDoc(configRef);
                                if (configSnap.exists()) {
                                    const allowed = configSnap.data().allowedEmails || [];
                                    const userEmailLower = currentUser.email.trim().toLowerCase();
                                    const allowedLower = allowed.map(e => e.trim().toLowerCase());
                                    if (allowedLower.includes(userEmailLower)) { setIsAdmin(true); setActiveTab('builder'); } 
                                    else { setIsAdmin(false); setAuthErrorMsg(`Email '${currentUser.email}' is not in the allowed list.`); }
                                } else { setAuthErrorMsg("Config document missing."); setIsAdmin(false); }
                            } catch (e) { setIsAdmin(false); setAuthErrorMsg("Permission Denied."); }
                        }
                    } else {
                        try { await window.signInAnonymously(window.auth); } catch (e) {}
                        setIsAdmin(false); setActiveTab('schedule');
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (window.db) {
                    const unsub = window.onSnapshot(
                        window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'vessel_schedules'),
                        (snapshot) => { setEntries(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); setLoading(false); },
                        (error) => { console.error(error); setLoading(false); }
                    );
                    return () => unsub();
                }
            }, []);

            const handleGoogleLogin = async () => { try { await window.signInWithPopup(window.auth, window.googleProvider); } catch (error) { alert("Login failed"); } };
            const handleLogout = async () => { await window.signOut(window.auth); await window.signInAnonymously(window.auth); setIsAdmin(false); setAuthErrorMsg(null); setActiveTab('schedule'); };

            const handleEdit = (entry) => { setFormData({ vessel: entry.vessel||'', voyage: entry.voyage||'', cfsClosing: entry.cfsClosing||'', etdHkg: entry.etdHkg||'', etaDest: entry.etaDest||'', destCode: entry.destCode||'', loadingDate: entry.loadingDate||'', carrier: entry.carrier||'', transitTime: entry.transitTime||'' }); setEditingId(entry.id); if(formTopRef.current) formTopRef.current.scrollIntoView({behavior:'smooth'}); };
            const cancelEditing = () => { setEditingId(null); setFormData({ vessel: '', voyage: '', cfsClosing: '', etdHkg: '', etaDest: '', destCode: 'HAM', loadingDate: '', carrier: '', transitTime: '' }); };
            const saveEntry = async (e) => { e.preventDefault(); if(!formData.vessel) return; if(!isAdmin) return alert("Access denied."); if(editingId) { await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'vessel_schedules', editingId), {...formData, updatedAt: new Date().toISOString()}); } else { await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'vessel_schedules'), {...formData, createdAt: new Date().toISOString()}); } setEditingId(null); setFormData({ vessel: '', voyage: '', cfsClosing: '', etdHkg: '', etaDest: '', destCode: formData.destCode, loadingDate: '', carrier: '', transitTime: '' }); };
            const removeEntry = async (id) => { if(!isAdmin) return alert("Access denied."); await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'vessel_schedules', id)); if(selectedEntryId===id) setSelectedEntryId(null); if(editingId===id) cancelEditing(); if(selectedForText.has(id)){ const newSet=new Set(selectedForText); newSet.delete(id); setSelectedForText(newSet); if(newSet.size===0) setSelectionDestCode(null); } };
            const getWeekNumber = (dStr) => { if (!dStr) return ''; const d = new Date(dStr); d.setHours(0,0,0,0); d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7); const w1 = new Date(d.getFullYear(), 0, 4); return 1 + Math.round(((d.getTime() - w1.getTime()) / 86400000 - 3 + (w1.getDay() + 6) % 7) / 7); };
            const formatDate = (s) => { if (!s) return ''; const [y, m, d] = s.split('-'); return new Date(y, m-1, d).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }).toUpperCase().replace(/ /g, '-'); };
            const handleInputChange = (e) => { let { name, value } = e.target; if (name === 'destCode') value = value.toUpperCase(); setFormData(prev => { const upd = { ...prev, [name]: value }; if (name === 'etdHkg' || name === 'etaDest') { const start = name === 'etdHkg' ? value : prev.etdHkg; const end = name === 'etaDest' ? value : prev.etaDest; if (start && end) { const diffDays = Math.round((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24)); if (!isNaN(diffDays)) upd.transitTime = diffDays.toString(); } } return upd; }); };
            const toggleSelection = (entry) => { const newSet = new Set(selectedForText); if (!newSet.has(entry.id)) { if (newSet.size > 0 && entry.destCode !== selectionDestCode) { alert(`Only select schedules for ${selectionDestCode}`); return; } if (newSet.size === 0) setSelectionDestCode(entry.destCode); newSet.add(entry.id); } else { newSet.delete(entry.id); if (newSet.size === 0) setSelectionDestCode(null); } setSelectedForText(newSet); };
            const copyToClipboard = () => { if (navigator.clipboard) { navigator.clipboard.writeText(generatedText); setCopied(true); setTimeout(() => setCopied(false), 2000); } };

            const today = new Date(); const pastDate = new Date(today); pastDate.setDate(today.getDate() - 21);
            const cutoffDate = `${pastDate.getFullYear()}-${String(pastDate.getMonth()+1).padStart(2,'0')}-${String(pastDate.getDate()).padStart(2,'0')}`;
            const visibleEntries = entries.filter(e => !e.cfsClosing || e.cfsClosing >= cutoffDate);
            const adminFilteredEntries = visibleEntries.filter(entry => { if (!adminSearchTerm) return true; const term = adminSearchTerm.toLowerCase(); return ((entry.vessel||'').toLowerCase().includes(term) || (entry.voyage||'').toLowerCase().includes(term) || (entry.destCode||'').toLowerCase().includes(term)); }).sort((a, b) => { if (adminSortBy === 'vessel') return (a.vessel||'').localeCompare(b.vessel||''); if (adminSortBy === 'pod') return (a.destCode||'').localeCompare(b.destCode||''); return new Date(a.etdHkg||0) - new Date(b.etdHkg||0); });
            const uniqueDestinations = [...new Set(visibleEntries.map(e => e.destCode))].filter(Boolean).sort();
            const filteredEntries = visibleEntries.filter(e => activeScheduleFilter === 'ALL' || e.destCode === activeScheduleFilter).sort((a, b) => new Date(a.etdHkg||0) - new Date(b.etdHkg||0));
            const selectedEntry = entries.find(e => e.id === selectedEntryId);

            useEffect(() => {
                let src = selectedForText.size > 0 ? entries.filter(e => selectedForText.has(e.id)) : [...visibleEntries]; 
                src.sort((a, b) => new Date(a.etdHkg||0) - new Date(b.etdHkg||0));
                const txt = src.map((e, i) => {
                    let b = []; b.push(displayConfig.showVesselLine ? `${i + 1}) M/V: ${e.vessel}${e.voyage ? ' / ' + e.voyage : ''}` : `${i + 1})`);
                    if (displayConfig.showCarrier && e.carrier) b.push(`CARRIER: ${e.carrier}`); if (displayConfig.showCfs && e.cfsClosing) b.push(`CFS CLOSING: ${formatDate(e.cfsClosing)}`); if (displayConfig.showLoad && e.loadingDate) b.push(`LOAD: ${formatDate(e.loadingDate)}`); if (displayConfig.showEtd && e.etdHkg) b.push(`ETD HKG: ${formatDate(e.etdHkg)}`); if (displayConfig.showEta && e.etaDest) b.push(`ETA ${e.destCode}: ${formatDate(e.etaDest)}`); if (displayConfig.showTt && e.transitTime) b.push(`TT: ${e.transitTime} DAYS`);
                    return b.join('\n');
                }).join('\n\n');
                setGeneratedText(txt);
            }, [entries, visibleEntries, displayConfig, selectedForText]);

            return (
                <div className="min-h-screen flex flex-col font-sans">
                    <nav className="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 text-white shadow-lg sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16 items-center">
                                <div className="flex items-center gap-3">
                                    <div className="bg-white/10 p-2 rounded-lg backdrop-blur-sm border border-white/10"><Icons.Ship size={24} className="text-blue-300" /></div>
                                    <div><h1 className="font-bold text-lg tracking-tight leading-tight">VesselManager</h1><p className="text-[10px] text-slate-400 font-medium tracking-wider uppercase">Logistics Dashboard</p></div>
                                </div>
                                <div className="flex items-center gap-6">
                                    {isAdmin && (
                                        <div className="hidden sm:flex bg-slate-800/50 p-1 rounded-lg border border-white/5">
                                            <button onClick={() => setActiveTab('builder')} className={`flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-all ${activeTab === 'builder' ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}><Icons.LayoutList size={16}/> Builder</button>
                                            <button onClick={() => setActiveTab('calculator')} className={`flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-all ${activeTab === 'calculator' ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}><Icons.Calculator size={16}/> Calculator</button>
                                            <button onClick={() => setActiveTab('schedule')} className={`flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-all ${activeTab === 'schedule' ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}><Icons.Table size={16}/> Schedule</button>
                                        </div>
                                    )}
                                    <div className="h-6 w-px bg-white/10 hidden sm:block"></div>
                                    {(user && !user.isAnonymous) ? (
                                        <div className="flex items-center gap-3">
                                            {isAdmin ? ( <span className="flex items-center gap-2 text-xs font-semibold text-emerald-400 bg-emerald-900/30 px-2 py-1 rounded border border-emerald-800 cursor-help" title="Admin Access"><Icons.CheckCircle size={12}/> Admin</span> ) : ( <span className="flex items-center gap-2 text-xs font-semibold text-slate-400 bg-slate-800/50 px-2 py-1 rounded border border-slate-700 cursor-pointer hover:bg-slate-700" onClick={() => alert(authErrorMsg || "Visitor Mode")}><Icons.User size={12}/> Visitor</span> )}
                                            <button onClick={handleLogout} className="text-xs text-rose-300 hover:text-rose-100 hover:underline">Sign Out</button>
                                        </div>
                                    ) : ( <button onClick={handleGoogleLogin} className="flex items-center gap-2 text-xs font-bold text-slate-900 bg-white hover:bg-slate-100 px-3 py-2 rounded-lg transition-colors shadow-sm"><Icons.Google size={14} /> Admin Login</button> )}
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full">
                        {loading ? ( <div className="flex flex-col items-center justify-center p-12 space-y-4"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div><p className="text-slate-400 text-sm animate-pulse">Syncing data...</p></div> ) : (
                            <>
                                {activeTab === 'builder' && isAdmin && (
                                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-fade">
                                        <div className="lg:col-span-7 space-y-8">
                                            <div ref={formTopRef} className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
                                                <div className="bg-slate-50/50 px-6 py-4 border-b border-slate-200 flex items-center gap-3"><div className={`p-2 rounded-full ${editingId ? 'bg-blue-100 text-blue-600' : 'bg-blue-100 text-blue-600'}`}>{editingId ? <Icons.Edit size={18} /> : <Icons.Plus size={18} />}</div><h2 className={`font-bold ${editingId ? 'text-blue-600' : 'text-slate-800'}`}>{editingId ? 'Edit Vessel' : 'New Vessel Entry'}</h2></div>
                                                <form onSubmit={saveEntry} className="p-6 space-y-6">
                                                    <div className="space-y-4"><h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">Vessel Identification</h3><div className="grid grid-cols-2 gap-4"><InputField label="Vessel Name" name="vessel" value={formData.vessel} onChange={handleInputChange} placeholder="e.g. EVER ALP" required className="col-span-2 md:col-span-1" /><InputField label="Voyage #" name="voyage" value={formData.voyage} onChange={handleInputChange} placeholder="e.g. 1377-015W" className="col-span-2 md:col-span-1" /><InputField label="Carrier" name="carrier" value={formData.carrier} onChange={handleInputChange} placeholder="e.g. COSCO" className="col-span-2" /></div></div>
                                                    <div className="space-y-4"><h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">Logistics Dates</h3><div className="grid grid-cols-2 md:grid-cols-3 gap-4"><SmartDateInput label="CFS Closing" name="cfsClosing" value={formData.cfsClosing} onChange={handleInputChange} /><SmartDateInput label="Loading Date" name="loadingDate" value={formData.loadingDate} onChange={handleInputChange} /><SmartDateInput label="ETD HKG" name="etdHkg" value={formData.etdHkg} onChange={handleInputChange} /></div></div>
                                                    <div className="space-y-4"><h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">Route & Transit</h3><div className="grid grid-cols-2 md:grid-cols-3 gap-4"><SmartDateInput label="ETA Dest" name="etaDest" value={formData.etaDest} onChange={handleInputChange} /><InputField label="POD Code" name="destCode" value={formData.destCode} onChange={handleInputChange} placeholder="HAM" /><InputField label="TT (Days)" name="transitTime" type="number" value={formData.transitTime} onChange={handleInputChange} placeholder="42" /></div></div>
                                                    <div className="pt-4 border-t border-slate-100 flex gap-3"><button type="submit" className="flex-grow bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-blue-200 transition-all flex items-center justify-center gap-2 transform active:scale-95">{editingId ? <><Icons.Edit size={20} /> Update Schedule</> : <><Icons.Plus size={20} /> Add to Schedule</>}</button>{editingId && <button type="button" onClick={cancelEditing} className="px-6 py-3 rounded-xl border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition-colors">Cancel</button>}</div>
                                                </form>
                                            </div>
                                            {visibleEntries.length > 0 && <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><div className="bg-slate-50/50 px-6 py-4 border-b border-slate-200 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><h2 className="font-bold text-slate-800">Quick Edit</h2><div className="flex flex-wrap items-center gap-2 w-full sm:w-auto"><div className="relative"><input type="text" placeholder="Search..." value={adminSearchTerm} onChange={e => setAdminSearchTerm(e.target.value)} className="pl-8 pr-3 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none w-full sm:w-48 transition-all" /><div className="absolute left-2.5 top-1.5 text-slate-400"><Icons.Search size={14} /></div></div><select value={adminSortBy} onChange={e => setAdminSortBy(e.target.value)} className="px-2 py-1.5 text-xs border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer"><option value="etd">Sort: ETD</option><option value="vessel">Sort: Name</option><option value="pod">Sort: POD</option></select>{selectedForText.size > 0 && <button onClick={() => {setSelectedForText(new Set()); setSelectionDestCode(null);}} className="text-xs bg-rose-50 text-rose-600 px-3 py-1.5 rounded-lg font-medium hover:bg-rose-100 transition-colors">Clear ({selectedForText.size})</button>}</div></div><div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-slate-50 text-slate-500 font-semibold uppercase text-xs tracking-wider"><tr><th className="px-4 py-3 w-8 text-center">Select</th><th className="px-4 py-3">Vessel</th><th className="px-4 py-3">ETD</th><th className="px-4 py-3">POD</th><th className="px-4 py-3">ETA</th><th className="px-4 py-3 text-right">Action</th></tr></thead><tbody className="divide-y divide-slate-100">{adminFilteredEntries.length === 0 ? <tr><td colSpan={6} className="p-8 text-center text-slate-400 italic">No matches found.</td></tr> : adminFilteredEntries.map((entry) => { const isSelected = selectedForText.has(entry.id); const isDisabled = selectionDestCode && entry.destCode !== selectionDestCode && !isSelected; const isEditing = editingId === entry.id; return (<tr key={entry.id} className={`group transition-all ${isSelected ? 'bg-blue-50/60' : 'hover:bg-slate-50'} ${isDisabled ? 'opacity-40 grayscale' : ''} ${isEditing ? 'bg-blue-50/30' : ''}`}><td className="px-4 py-4 text-center"><button onClick={() => toggleSelection(entry)} disabled={isDisabled} className={`w-5 h-5 rounded-md border flex items-center justify-center transition-all ${isSelected ? 'bg-blue-600 border-blue-600 text-white scale-110 shadow-sm' : 'border-slate-300 text-transparent hover:border-blue-400'}`}><Icons.CheckCircle size={14} /></button></td><td className="px-4 py-4"><div className="font-bold text-slate-800">{entry.vessel}</div><div className="text-xs text-slate-500 font-mono mt-0.5">{entry.voyage}</div></td><td className="px-4 py-4 text-slate-600 font-medium text-xs whitespace-nowrap">{formatDate(entry.etdHkg)}</td><td className="px-4 py-4 text-slate-600 font-bold text-xs">{entry.destCode}</td><td className="px-4 py-4 text-slate-600 font-medium text-xs whitespace-nowrap">{formatDate(entry.etaDest)}</td><td className="px-4 py-4 text-right"><div className="flex justify-end gap-2"><button onClick={() => handleEdit(entry)} className="text-slate-300 hover:text-blue-500 p-2 rounded-lg hover:bg-blue-50 transition-all"><Icons.Edit size={18}/></button><button onClick={() => removeEntry(entry.id)} className="text-slate-300 hover:text-rose-500 p-2 rounded-lg hover:bg-rose-50 transition-all"><Icons.Trash2 size={18} /></button></div></td></tr>); })}</tbody></table></div></div>}
                                        </div>
                                        <div className="lg:col-span-5 space-y-6">
                                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6"><div className="flex items-center gap-2 mb-4 text-slate-800"><Icons.Settings size={20} className="text-blue-600" /><h3 className="font-bold">Output Config</h3></div><div className="flex flex-wrap gap-2">{['showVesselLine:Vessel', 'showCarrier:Carrier', 'showEtd:ETD', 'showEta:ETA', 'showCfs:CFS', 'showLoad:Load', 'showTt:TT'].map(opt => { const [key, label] = opt.split(':'); return (<button key={key} onClick={() => setDisplayConfig(p => ({...p, [key]: !p[key]}))} className={`px-3 py-1.5 text-xs font-semibold rounded-lg border transition-all ${displayConfig[key] ? 'bg-blue-50 border-blue-200 text-blue-700 shadow-sm' : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'}`}>{label}</button>) })}</div></div>
                                            <div className="bg-slate-900 rounded-2xl shadow-xl border border-slate-800 overflow-hidden flex flex-col h-[500px]"><div className="bg-slate-950 px-5 py-4 flex justify-between items-center border-b border-slate-800"><span className="font-mono text-xs text-blue-400 font-bold uppercase tracking-wider flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div> Output Preview</span><button onClick={copyToClipboard} className={`text-xs font-bold px-3 py-1.5 rounded-lg transition-all ${copied ? 'bg-emerald-500 text-white' : 'bg-blue-600 text-white hover:bg-blue-500'}`}>{copied ? 'COPIED!' : 'COPY TEXT'}</button></div><div className="relative flex-grow bg-slate-900"><textarea readOnly value={generatedText} className="w-full h-full bg-transparent p-6 text-slate-300 font-mono text-xs leading-relaxed focus:outline-none resize-none relative z-10" />{generatedText === '' && <div className="absolute inset-0 flex items-center justify-center text-slate-700 text-sm font-mono z-0">Ready for data...</div>}</div></div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'calculator' && isAdmin && (
                                    <div className="animate-fade">
                                        <DestCalcTool />
                                    </div>
                                )}

                                {activeTab === 'schedule' && (
                                    <div className="space-y-8 animate-fade pb-12">
                                        <div className="flex items-center gap-2 overflow-x-auto pb-4 scrollbar-hide"><button onClick={() => { setActiveScheduleFilter('ALL'); setSelectedEntryId(null); }} className={`flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-bold transition-all shadow-sm border ${activeScheduleFilter === 'ALL' ? 'bg-slate-800 text-white border-slate-800 ring-2 ring-slate-200' : 'bg-white text-slate-600 border-slate-200 hover:border-blue-300 hover:text-blue-600'}`}><span>All Ports</span> <span className={`px-1.5 py-0.5 rounded-md text-[10px] ${activeScheduleFilter === 'ALL' ? 'bg-white/20 text-white' : 'bg-slate-100 text-slate-500'}`}>{visibleEntries.length}</span></button><div className="w-px h-8 bg-slate-200 mx-2"></div>{uniqueDestinations.map(dest => (<button key={dest} onClick={() => { setActiveScheduleFilter(dest); setSelectedEntryId(null); }} className={`flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-bold transition-all shadow-sm border ${activeScheduleFilter === dest ? 'bg-blue-600 text-white border-blue-600 ring-2 ring-blue-100' : 'bg-white text-slate-600 border-slate-200 hover:border-blue-300 hover:text-blue-600'}`}><Icons.MapPin size={16} className={activeScheduleFilter === dest ? 'text-white' : 'text-slate-400'} /> <span>{dest}</span> </button>))}</div>
                                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><div className="overflow-x-auto"><table className="w-full"><thead><tr className="bg-slate-50 border-b border-slate-200 text-xs uppercase tracking-wider text-slate-500 font-bold"><th className="px-6 py-4 w-20 text-center bg-slate-100/50">Wk</th><th className="px-6 py-4 text-left">Vessel / Voyage</th><th className="px-6 py-4 text-left">Closing</th>{isAdmin && <th className="px-6 py-4 text-left">Load</th>}<th className="px-6 py-4 text-left">ETD HKG</th><th className="px-6 py-4 text-left">{activeScheduleFilter === 'ALL' ? 'ETA / POD' : `ETA ${activeScheduleFilter}`}</th><th className="px-6 py-4 text-left">Carrier</th><th className="px-6 py-4 text-center">T.T</th>{isAdmin && <th className="px-6 py-4 w-10"></th>}</tr></thead><tbody className="divide-y divide-slate-100 text-sm font-medium">{filteredEntries.length === 0 ? <tr><td colSpan={isAdmin ? 8 : 7} className="p-16 text-center text-slate-400 italic">No recent schedules found.</td></tr> : filteredEntries.map((entry) => (<tr key={entry.id} onClick={() => setSelectedEntryId(entry.id)} className={`group cursor-pointer transition-all hover:bg-slate-50 ${selectedEntryId === entry.id ? 'bg-blue-50/60 border-l-4 border-l-blue-600' : 'border-l-4 border-l-transparent'}`}><td className="px-6 py-4 text-center"><span className="text-slate-400 text-xs">#</span>{getWeekNumber(entry.etdHkg)}</td><td className="px-6 py-4"><div className="font-bold text-slate-800 text-base">{entry.vessel}</div><div className="text-xs text-slate-500 font-mono mt-1 bg-slate-100 inline-block px-1.5 py-0.5 rounded">{entry.voyage}</div></td><td className="px-6 py-4 text-slate-600 tabular-nums">{formatDate(entry.cfsClosing)}</td>{isAdmin && <td className="px-6 py-4 text-slate-600 tabular-nums">{formatDate(entry.loadingDate)}</td>}<td className="px-6 py-4 text-blue-700 font-bold tabular-nums">{formatDate(entry.etdHkg)}</td><td className="px-6 py-4"><div className="flex items-center gap-2"><span className="tabular-nums text-slate-700">{formatDate(entry.etaDest)}</span>{activeScheduleFilter === 'ALL' && <span className="text-[10px] font-bold bg-slate-200 text-slate-700 px-1.5 py-0.5 rounded">{entry.destCode}</span>}</div></td><td className="px-6 py-4"><span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-indigo-50 text-indigo-700 border border-indigo-100">{entry.carrier}</span></td><td className="px-6 py-4 text-center"><span className="text-slate-600 font-bold bg-slate-100 px-2 py-1 rounded-md">{entry.transitTime}</span></td>{isAdmin && (<td className="px-6 py-4 text-center"><button onClick={(e) => {e.stopPropagation(); removeEntry(entry.id);}} className="text-slate-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icons.Trash2 size={18}/></button></td>)}</tr>))}</tbody></table></div></div>
                                        <div className="pt-4"><CalendarWidget entry={selectedEntry} isAdmin={isAdmin} /></div>
                                    </div>
                                )}
                            </>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<VesselScheduleApp />);
    </script>
</body>
</html>
