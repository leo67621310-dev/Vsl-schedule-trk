<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vessel Schedule Manager</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        textarea, pre, code { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 300ms, transform 300ms; }
        
        /* Glassmorphism helpers */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <div id="root"></div>

    <!-- Firebase Initialization -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        //  CONFIGURATION SECTION - PASTE KEYS HERE
        // ==========================================
        
        // 1. Go to Firebase Console > Project Settings > General > Your Apps
        // 2. Select "Config" and copy the object (apiKey, authDomain, etc)
        // 3. Paste it inside the variable below:
        
        const firebaseConfig = {
            // apiKey: "AIzaSy...",
            // authDomain: "project-id.firebaseapp.com",
            // projectId: "project-id",
            // storageBucket: "project-id.appspot.com",
            // messagingSenderId: "...",
            // appId: "..."
        };

        const appId = 'vessel-schedule-app'; 

        // ==========================================
        //  END CONFIGURATION
        // ==========================================

        let isFirebaseInitialized = false;

        // Check if config is filled out (has at least an apiKey)
        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);

                // Expose to window for React component to use
                window.db = db;
                window.auth = auth;
                window.collection = collection;
                window.addDoc = addDoc;
                window.updateDoc = updateDoc;
                window.deleteDoc = deleteDoc;
                window.doc = doc;
                window.onSnapshot = onSnapshot;
                window.appId = appId;
                window.signInAnonymously = signInAnonymously;
                window.onAuthStateChanged = onAuthStateChanged;
                isFirebaseInitialized = true;
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        } else {
            console.log("Running in Local Mode (Firebase keys not set in index.html)");
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const IconWrapper = ({ children, size = 20, className = "", onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick}>
                {children}
            </svg>
        );

        const Icons = {
            Plus: (props) => <IconWrapper {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>,
            Trash2: (props) => <IconWrapper {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>,
            Edit: (props) => <IconWrapper {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconWrapper>,
            Clipboard: (props) => <IconWrapper {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></IconWrapper>,
            Settings: (props) => <IconWrapper {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>,
            Ship: (props) => <IconWrapper {...props}><path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M19.38 20A11.6 11.6 0 0 0 21 14l-9-4-9 4c0 2.9.9 5.8 2.38 8"/><path d="M12 10V4"/><path d="M8 8v1"/><path d="M16 8v1"/></IconWrapper>,
            Calendar: (props) => <IconWrapper {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconWrapper>,
            Anchor: (props) => <IconWrapper {...props}><circle cx="12" cy="5" r="3"/><line x1="12" x2="12" y1="22" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></IconWrapper>,
            ArrowRight: (props) => <IconWrapper {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconWrapper>,
            CheckSquare: (props) => <IconWrapper {...props}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></IconWrapper>,
            Square: (props) => <IconWrapper {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/></IconWrapper>,
            LayoutList: (props) => <IconWrapper {...props}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/><path d="M14 4h7"/><path d="M14 9h7"/><path d="M14 15h7"/><path d="M14 20h7"/></IconWrapper>,
            Table: (props) => <IconWrapper {...props}><path d="M12 3v18"/><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/></IconWrapper>,
            MapPin: (props) => <IconWrapper {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconWrapper>,
            ChevronLeft: (props) => <IconWrapper {...props}><path d="m15 18-6-6 6-6"/></IconWrapper>,
            ChevronRight: (props) => <IconWrapper {...props}><path d="m9 18 6-6-6-6"/></IconWrapper>,
            Info: (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconWrapper>,
            CheckCircle: (props) => <IconWrapper {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconWrapper>,
            Lock: (props) => <IconWrapper {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconWrapper>,
            Unlock: (props) => <IconWrapper {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></IconWrapper>,
            X: (props) => <IconWrapper {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>,
            Search: (props) => <IconWrapper {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconWrapper>,
        };

        // --- Helper Components ---
        
        const InputField = ({ label, name, type = "text", placeholder, value, onChange, required = false, className = "" }) => (
            <div className={`flex flex-col ${className}`}>
                <label className="text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">{label}</label>
                <input
                    type={type}
                    name={name}
                    value={value}
                    onChange={onChange}
                    placeholder={placeholder}
                    required={required}
                    className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white text-slate-800 text-sm transition-all"
                />
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm animate-in fade-in zoom-in duration-200 transform scale-100">
                        <div className="flex justify-between items-center mb-6 border-b border-slate-100 pb-2">
                            <h3 className="text-lg font-bold text-slate-800">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 transition-colors"><Icons.X size={20}/></button>
                        </div>
                        {children}
                    </div>
                </div>
            );
        };

        const SmartDateInput = ({ label, name, value, onChange, placeholder = "DD/MM/YY", required = false, className = "" }) => {
            const [displayValue, setDisplayValue] = useState('');
            const [error, setError] = useState(false);

            useEffect(() => {
                if (value) {
                    const [y, m, d] = value.split('-');
                    if (y && m && d) setDisplayValue(`${d}/${m}/${y.slice(-2)}`);
                } else setDisplayValue('');
                setError(false);
            }, [value]);

            const parseAndSubmit = (inputVal) => {
                if (!inputVal.trim()) {
                    onChange({ target: { name, value: '' } });
                    return;
                }
                let d, m, y;
                const clean = inputVal.replace(/[^0-9]/g, ' ').trim().split(/\s+/);
                if (clean.length === 1 && clean[0].length === 6) { d = clean[0].substring(0, 2); m = clean[0].substring(2, 4); y = clean[0].substring(4, 6); } 
                else if (clean.length === 3) { [d, m, y] = clean; }

                if (d && m && y) {
                    let numY = parseInt(y, 10);
                    let numM = parseInt(m, 10);
                    let numD = parseInt(d, 10);
                    if (numY < 100) numY += 2000;
                    const dateObj = new Date(numY, numM - 1, numD);
                    if (dateObj.getFullYear() === numY && dateObj.getMonth() === numM - 1 && dateObj.getDate() === numD) {
                        const localIsoDate = `${numY}-${String(numM).padStart(2, '0')}-${String(numD).padStart(2, '0')}`;
                        onChange({ target: { name, value: localIsoDate } });
                        setDisplayValue(`${numD.toString().padStart(2, '0')}/${numM.toString().padStart(2, '0')}/${numY.toString().slice(-2)}`);
                        setError(false);
                        return;
                    }
                }
                setError(true);
            };

            return (
                <div className={`flex flex-col ${className}`}>
                    <label className="text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide flex justify-between">
                        {label}
                        {error && <span className="text-rose-500 normal-case text-[10px] font-medium animate-pulse">Invalid</span>}
                    </label>
                    <div className="relative group">
                        <input type="text" name={name} value={displayValue} onChange={(e) => setDisplayValue(e.target.value)} onBlur={() => parseAndSubmit(displayValue)} onKeyDown={(e) => e.key === 'Enter' && parseAndSubmit(displayValue)} placeholder={placeholder} required={required} 
                            className={`w-full px-3 py-2 bg-slate-50 border rounded-lg focus:outline-none focus:ring-2 focus:bg-white text-slate-800 text-sm transition-all ${error ? 'border-rose-300 ring-rose-100 focus:ring-rose-200' : 'border-slate-200 focus:ring-blue-500 group-hover:border-slate-300'}`} />
                        <div className="absolute right-3 top-2.5 pointer-events-none text-slate-400 group-hover:text-blue-500 transition-colors"><Icons.Calendar size={14} /></div>
                    </div>
                </div>
            );
        };

        const CalendarWidget = ({ entry, isAdmin }) => { 
            const [currentDate, setCurrentDate] = useState(new Date());

            useEffect(() => {
                if (entry) {
                    const initialDateStr = entry.cfsClosing || entry.loadingDate || entry.etdHkg || entry.etaDest;
                    if (initialDateStr) {
                        const [y,m,d] = initialDateStr.split('-').map(Number);
                        setCurrentDate(new Date(y, m-1, d));
                    }
                }
            }, [entry]);

            if (!entry) return <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-12 text-center text-slate-400 flex flex-col items-center gap-4"><div className="opacity-20"><Icons.Calendar size={48} /></div><p>Select a vessel to view calendar.</p></div>;

            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
            const changeMonth = (offset) => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1));

            const events = [
                { type: 'CFS', date: entry.cfsClosing, color: 'bg-rose-100 text-rose-700 border-rose-200' },
                ...(isAdmin ? [{ type: 'LOAD', date: entry.loadingDate, color: 'bg-amber-100 text-amber-700 border-amber-200' }] : []),
                { type: 'ETD', date: entry.etdHkg, color: 'bg-blue-100 text-blue-700 border-blue-200' },
                { type: 'ETA', date: entry.etaDest, color: 'bg-emerald-100 text-emerald-700 border-emerald-200' }
            ].filter(e => e.date);

            const days = [];
            for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} className="h-24 bg-slate-50/50 border-r border-b border-slate-100"></div>);
            for (let d = 1; d <= daysInMonth; d++) {
                const dayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), d);
                const currentDayStr = `${dayDate.getFullYear()}-${String(dayDate.getMonth()+1).padStart(2,'0')}-${String(dayDate.getDate()).padStart(2,'0')}`;
                const dayEvents = events.filter(e => e.date === currentDayStr);
                days.push(
                    <div key={d} className="h-24 border-r border-b border-slate-100 p-1 relative hover:bg-slate-50 transition-colors group">
                        <span className={`text-xs font-semibold p-1.5 rounded-full inline-block w-6 h-6 text-center leading-3 ${dayEvents.length > 0 ? 'bg-slate-800 text-white shadow-sm' : 'text-slate-400'}`}>{d}</span>
                        <div className="flex flex-col gap-1 mt-1">{dayEvents.map((ev, idx) => <div key={idx} className={`text-[10px] px-1.5 py-0.5 rounded border ${ev.color} font-bold shadow-sm truncate`}>{ev.type}</div>)}</div>
                    </div>
                );
            }

            return (
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="p-4 border-b border-slate-200 flex items-center justify-between bg-slate-50/50">
                        <div className="flex items-center gap-3"><div className="bg-gradient-to-br from-blue-600 to-indigo-700 p-2.5 rounded-xl text-white shadow-md"><Icons.Calendar size={20} /></div><div><h3 className="font-bold text-slate-800">{entry.vessel}</h3><p className="text-xs text-slate-500 font-medium">Logistics Timeline</p></div></div>
                        <div className="flex items-center bg-white rounded-lg border border-slate-200 shadow-sm">
                            <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-slate-50 text-slate-600 rounded-l-lg transition-colors"><Icons.ChevronLeft size={16} /></button>
                            <span className="px-4 text-sm font-semibold min-w-[140px] text-center text-slate-700">{currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })}</span>
                            <button onClick={() => changeMonth(1)} className="p-2 hover:bg-slate-50 text-slate-600 rounded-r-lg transition-colors"><Icons.ChevronRight size={16} /></button>
                        </div>
                    </div>
                    <div className="grid grid-cols-7 bg-slate-50 text-[10px] font-bold text-slate-400 text-center py-2.5 border-b border-slate-200 uppercase tracking-widest"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
                    <div className="grid grid-cols-7 bg-white">{days}</div>
                </div>
            );
        };

        const VesselScheduleApp = () => {
            const [entries, setEntries] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isAdmin, setIsAdmin] = useState(false);
            const [showAdminModal, setShowAdminModal] = useState(false);
            const [adminPassword, setAdminPassword] = useState('');
            
            const [activeTab, setActiveTab] = useState('schedule'); 
            const [activeScheduleFilter, setActiveScheduleFilter] = useState('ALL');
            const [selectedEntryId, setSelectedEntryId] = useState(null);
            const [selectedForText, setSelectedForText] = useState(new Set());
            const [selectionDestCode, setSelectionDestCode] = useState(null);
            const [editingId, setEditingId] = useState(null);
            
            const [adminSearchTerm, setAdminSearchTerm] = useState('');
            const [adminSortBy, setAdminSortBy] = useState('etd'); 
            
            const [user, setUser] = useState(null); 
            
            const formTopRef = useRef(null);

            const [formData, setFormData] = useState({ vessel: '', voyage: '', cfsClosing: '', etdHkg: '', etaDest: '', destCode: 'HAM', loadingDate: '', carrier: '', transitTime: '' });
            const [displayConfig, setDisplayConfig] = useState({ showVesselLine: true, showCarrier: true, showCfs: true, showLoad: true, showEtd: true, showEta: true, showTt: true });
            const [generatedText, setGeneratedText] = useState('');
            const [copied, setCopied] = useState(false);

            useEffect(() => {
                const initAuth = async () => {
                    if (window.auth) {
                        try {
                            await window.signInAnonymously(window.auth);
                            window.onAuthStateChanged(window.auth, (u) => {
                                setUser(u);
                                if (!u) setLoading(false);
                            });
                        } catch (error) {
                            console.error("Auth failed (likely Authorized Domain issue):", error);
                            alert("Authentication failed. If deploying to Vercel, please add your Vercel domain to Firebase Console > Authentication > Settings > Authorized Domains.");
                            setLoading(false);
                        }
                    } else {
                        // Local mode
                        const saved = localStorage.getItem('vesselEntries');
                        if (saved) setEntries(JSON.parse(saved));
                        setLoading(false);
                    }
                };
                initAuth();
            }, []);

            useEffect(() => {
                if (window.db && user) {
                    const unsub = window.onSnapshot(
                        window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'vessel_schedules'),
                        (snapshot) => {
                            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setEntries(data);
                            setLoading(false);
                        },
                        (error) => { console.error("Firestore error:", error); setLoading(false); }
                    );
                    return () => unsub();
                }
            }, [user]);

            const handleAdminLogin = (e) => {
                e.preventDefault();
                if (adminPassword === '1234') {
                    setIsAdmin(true);
                    setActiveTab('builder');
                    setShowAdminModal(false);
                    setAdminPassword('');
                } else {
                    alert('Incorrect password. Try "1234"');
                }
            };

            const handleLogout = () => {
                setIsAdmin(false);
                setActiveTab('schedule');
            };

            const handleEdit = (entry) => {
                setFormData({
                    vessel: entry.vessel || '',
                    voyage: entry.voyage || '',
                    cfsClosing: entry.cfsClosing || '',
                    etdHkg: entry.etdHkg || '',
                    etaDest: entry.etaDest || '',
                    destCode: entry.destCode || '',
                    loadingDate: entry.loadingDate || '',
                    carrier: entry.carrier || '',
                    transitTime: entry.transitTime || ''
                });
                setEditingId(entry.id);
                if (formTopRef.current) formTopRef.current.scrollIntoView({ behavior: 'smooth' });
            };

            const cancelEditing = () => {
                setEditingId(null);
                setFormData({ vessel: '', voyage: '', cfsClosing: '', etdHkg: '', etaDest: '', destCode: 'HAM', loadingDate: '', carrier: '', transitTime: '' });
            };

            const saveEntry = async (e) => {
                e.preventDefault();
                if (!formData.vessel) return;

                if (window.db) {
                    if (editingId) {
                        await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'vessel_schedules', editingId), { ...formData, updatedAt: new Date().toISOString() });
                    } else {
                        await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'vessel_schedules'), { ...formData, createdAt: new Date().toISOString() });
                    }
                } else {
                    let newEntries;
                    if (editingId) {
                        newEntries = entries.map(ent => ent.id === editingId ? { ...ent, ...formData } : ent);
                    } else {
                        const newEntry = { ...formData, id: Date.now().toString() };
                        newEntries = [...entries, newEntry];
                    }
                    setEntries(newEntries);
                    localStorage.setItem('vesselEntries', JSON.stringify(newEntries));
                }
                setEditingId(null);
                setFormData({ vessel: '', voyage: '', cfsClosing: '', etdHkg: '', etaDest: '', destCode: formData.destCode, loadingDate: '', carrier: '', transitTime: '' });
            };

            const removeEntry = async (id) => {
                if (window.db) {
                    await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'vessel_schedules', id));
                } else {
                    const newEntries = entries.filter(e => e.id !== id);
                    setEntries(newEntries);
                    localStorage.setItem('vesselEntries', JSON.stringify(newEntries));
                }
                if (selectedEntryId === id) setSelectedEntryId(null);
                if (editingId === id) cancelEditing();
                if (selectedForText.has(id)) {
                    const newSet = new Set(selectedForText);
                    newSet.delete(id);
                    setSelectedForText(newSet);
                    if (newSet.size === 0) setSelectionDestCode(null);
                }
            };

            const getWeekNumber = (dStr) => { if (!dStr) return ''; const d = new Date(dStr); d.setHours(0,0,0,0); d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7); const w1 = new Date(d.getFullYear(), 0, 4); return 1 + Math.round(((d.getTime() - w1.getTime()) / 86400000 - 3 + (w1.getDay() + 6) % 7) / 7); };
            
            const formatDate = (s) => { 
                if (!s) return ''; 
                const [y, m, d] = s.split('-'); 
                return new Date(y, m-1, d).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }).toUpperCase().replace(/ /g, '-'); 
            };
            
            const handleInputChange = (e) => {
                let { name, value } = e.target;
                if (name === 'destCode') value = value.toUpperCase();
                setFormData(prev => {
                    const upd = { ...prev, [name]: value };
                    if (name === 'etdHkg' || name === 'etaDest') {
                        const start = name === 'etdHkg' ? value : prev.etdHkg;
                        const end = name === 'etaDest' ? value : prev.etaDest;
                        if (start && end) {
                            const diffDays = Math.round((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24));
                            if (!isNaN(diffDays)) upd.transitTime = diffDays.toString();
                        }
                    }
                    return upd;
                });
            };

            const toggleSelection = (entry) => {
                const newSet = new Set(selectedForText);
                if (!newSet.has(entry.id)) {
                    if (newSet.size > 0 && entry.destCode !== selectionDestCode) { alert(`Only select schedules for ${selectionDestCode}`); return; }
                    if (newSet.size === 0) setSelectionDestCode(entry.destCode);
                    newSet.add(entry.id);
                } else {
                    newSet.delete(entry.id);
                    if (newSet.size === 0) setSelectionDestCode(null);
                }
                setSelectedForText(newSet);
            };

            const copyToClipboard = () => {
                if (navigator.clipboard) { navigator.clipboard.writeText(generatedText); setCopied(true); setTimeout(() => setCopied(false), 2000); }
            };

            const today = new Date();
            const pastDate = new Date(today);
            pastDate.setDate(today.getDate() - 21);
            const cutoffDate = `${pastDate.getFullYear()}-${String(pastDate.getMonth()+1).padStart(2,'0')}-${String(pastDate.getDate()).padStart(2,'0')}`;

            const visibleEntries = entries.filter(e => !e.cfsClosing || e.cfsClosing >= cutoffDate);

            const adminFilteredEntries = visibleEntries.filter(entry => {
                if (!adminSearchTerm) return true;
                const term = adminSearchTerm.toLowerCase();
                return (
                    (entry.vessel || '').toLowerCase().includes(term) ||
                    (entry.voyage || '').toLowerCase().includes(term) ||
                    (entry.destCode || '').toLowerCase().includes(term)
                );
            }).sort((a, b) => {
                if (adminSortBy === 'vessel') return (a.vessel || '').localeCompare(b.vessel || '');
                if (adminSortBy === 'pod') return (a.destCode || '').localeCompare(b.destCode || '');
                return new Date(a.etdHkg || 0) - new Date(b.etdHkg || 0);
            });

            const uniqueDestinations = [...new Set(visibleEntries.map(e => e.destCode))].filter(Boolean).sort();
            const filteredEntries = visibleEntries.filter(e => activeScheduleFilter === 'ALL' || e.destCode === activeScheduleFilter)
                .sort((a, b) => new Date(a.etdHkg || 0) - new Date(b.etdHkg || 0));
            const selectedEntry = entries.find(e => e.id === selectedEntryId);

            useEffect(() => {
                let src = selectedForText.size > 0 ? entries.filter(e => selectedForText.has(e.id)) : [...visibleEntries]; 
                src.sort((a, b) => new Date(a.etdHkg || 0) - new Date(b.etdHkg || 0));
                
                const txt = src.map((e, i) => {
                    let b = [];
                    b.push(displayConfig.showVesselLine ? `${i + 1}) M/V: ${e.vessel}${e.voyage ? ' / ' + e.voyage : ''}` : `${i + 1})`);
                    if (displayConfig.showCarrier && e.carrier) b.push(`CARRIER: ${e.carrier}`);
                    if (displayConfig.showCfs && e.cfsClosing) b.push(`CFS CLOSING: ${formatDate(e.cfsClosing)}`);
                    if (displayConfig.showLoad && e.loadingDate) b.push(`LOAD: ${formatDate(e.loadingDate)}`);
                    if (displayConfig.showEtd && e.etdHkg) b.push(`ETD HKG: ${formatDate(e.etdHkg)}`);
                    if (displayConfig.showEta && e.etaDest) b.push(`ETA ${e.destCode}: ${formatDate(e.etaDest)}`);
                    if (displayConfig.showTt && e.transitTime) b.push(`TT: ${e.transitTime} DAYS`);
                    return b.join('\n');
                }).join('\n\n');
                setGeneratedText(txt);
            }, [entries, visibleEntries, displayConfig, selectedForText]);

            return (
                <div className="min-h-screen flex flex-col font-sans">
                    <nav className="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 text-white shadow-lg sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16 items-center">
                                <div className="flex items-center gap-3">
                                    <div className="bg-white/10 p-2 rounded-lg backdrop-blur-sm border border-white/10"><Icons.Ship size={24} className="text-blue-300" /></div>
                                    <div>
                                        <h1 className="font-bold text-lg tracking-tight leading-tight">VesselManager</h1>
                                        <p className="text-[10px] text-slate-400 font-medium tracking-wider uppercase">Logistics Dashboard</p>
                                    </div>
                                    {!window.db && <span className="ml-2 px-2 py-0.5 rounded text-[10px] bg-yellow-500/20 text-yellow-200 border border-yellow-500/30 font-bold uppercase tracking-wide">Local Mode</span>}
                                </div>
                                <div className="flex items-center gap-6">
                                    <div className="hidden sm:flex bg-slate-800/50 p-1 rounded-lg border border-white/5">
                                        {isAdmin && (
                                            <button onClick={() => setActiveTab('builder')} className={`flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-all ${activeTab === 'builder' ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}>
                                                <Icons.LayoutList size={16}/> Builder
                                            </button>
                                        )}
                                        <button onClick={() => setActiveTab('schedule')} className={`flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-all ${activeTab === 'schedule' ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}>
                                            <Icons.Table size={16}/> Schedule
                                        </button>
                                    </div>
                                    <div className="h-6 w-px bg-white/10 hidden sm:block"></div>
                                    {isAdmin ? (
                                        <button onClick={handleLogout} className="flex items-center gap-2 text-xs font-semibold text-rose-300 hover:text-rose-100 px-3 py-1.5 rounded-lg hover:bg-rose-500/20 transition-colors border border-transparent hover:border-rose-500/30">
                                            <Icons.Unlock size={14} /> Admin
                                        </button>
                                    ) : (
                                        <button onClick={() => setShowAdminModal(true)} className="flex items-center gap-2 text-xs font-semibold text-slate-300 hover:text-white px-3 py-1.5 rounded-lg hover:bg-white/10 transition-colors">
                                            <Icons.Lock size={14} /> Visitor
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full">
                        {loading ? (
                            <div className="flex flex-col items-center justify-center p-12 space-y-4">
                                <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
                                <p className="text-slate-400 text-sm animate-pulse">Loading logistics data...</p>
                            </div>
                        ) : (
                            <>
                                {activeTab === 'builder' && isAdmin && (
                                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-fade">
                                        <div className="lg:col-span-7 space-y-8">
                                            <div ref={formTopRef} className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
                                                <div className="bg-slate-50/50 px-6 py-4 border-b border-slate-200 flex items-center gap-3">
                                                    <div className={`p-2 rounded-full ${editingId ? 'bg-blue-100 text-blue-600' : 'bg-blue-100 text-blue-600'}`}>
                                                        {editingId ? <Icons.Edit size={18} /> : <Icons.Plus size={18} />}
                                                    </div>
                                                    <h2 className={`font-bold ${editingId ? 'text-blue-600' : 'text-slate-800'}`}>
                                                        {editingId ? 'Edit Vessel' : 'New Vessel Entry'}
                                                    </h2>
                                                </div>
                                                <form onSubmit={saveEntry} className="p-6 space-y-6">
                                                    {/* Section 1 */}
                                                    <div className="space-y-4">
                                                        <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">Vessel Identification</h3>
                                                        <div className="grid grid-cols-2 gap-4">
                                                            <InputField label="Vessel Name" name="vessel" value={formData.vessel} onChange={handleInputChange} placeholder="e.g. EVER ALP" required className="col-span-2 md:col-span-1" />
                                                            <InputField label="Voyage #" name="voyage" value={formData.voyage} onChange={handleInputChange} placeholder="e.g. 1377-015W" className="col-span-2 md:col-span-1" />
                                                            <InputField label="Carrier" name="carrier" value={formData.carrier} onChange={handleInputChange} placeholder="e.g. COSCO" className="col-span-2" />
                                                        </div>
                                                    </div>

                                                    {/* Section 2 */}
                                                    <div className="space-y-4">
                                                        <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">Logistics Dates</h3>
                                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                                            <SmartDateInput label="CFS Closing" name="cfsClosing" value={formData.cfsClosing} onChange={handleInputChange} />
                                                            <SmartDateInput label="Loading Date" name="loadingDate" value={formData.loadingDate} onChange={handleInputChange} />
                                                            <SmartDateInput label="ETD HKG" name="etdHkg" value={formData.etdHkg} onChange={handleInputChange} />
                                                        </div>
                                                    </div>

                                                    {/* Section 3 */}
                                                    <div className="space-y-4">
                                                        <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">Route & Transit</h3>
                                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                                            <SmartDateInput label="ETA Dest" name="etaDest" value={formData.etaDest} onChange={handleInputChange} />
                                                            <InputField label="POD Code" name="destCode" value={formData.destCode} onChange={handleInputChange} placeholder="HAM" />
                                                            <InputField label="TT (Days)" name="transitTime" type="number" value={formData.transitTime} onChange={handleInputChange} placeholder="42" />
                                                        </div>
                                                    </div>

                                                    <div className="pt-4 border-t border-slate-100 flex gap-3">
                                                        <button type="submit" className="flex-grow bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-blue-200 transition-all flex items-center justify-center gap-2 transform active:scale-95">
                                                            {editingId ? <><Icons.Edit size={20} /> Update Schedule</> : <><Icons.Plus size={20} /> Add to Schedule</>}
                                                        </button>
                                                        {editingId && (
                                                            <button type="button" onClick={cancelEditing} className="px-6 py-3 rounded-xl border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition-colors">
                                                                Cancel
                                                            </button>
                                                        )}
                                                    </div>
                                                </form>
                                            </div>

                                            {/* UPDATED: Uses visibleEntries instead of all entries */}
                                            {visibleEntries.length > 0 && (
                                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                                    <div className="bg-slate-50/50 px-6 py-4 border-b border-slate-200 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                                        <h2 className="font-bold text-slate-800">Quick Edit</h2>
                                                        
                                                        <div className="flex flex-wrap items-center gap-2 w-full sm:w-auto">
                                                            {/* Search Box */}
                                                            <div className="relative">
                                                                <input 
                                                                    type="text" 
                                                                    placeholder="Search Vessel/Voy/POD..." 
                                                                    value={adminSearchTerm}
                                                                    onChange={e => setAdminSearchTerm(e.target.value)}
                                                                    className="pl-8 pr-3 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none w-full sm:w-48 transition-all"
                                                                />
                                                                <div className="absolute left-2.5 top-1.5 text-slate-400"><Icons.Search size={14} /></div>
                                                            </div>

                                                            {/* Sort Dropdown */}
                                                            <select 
                                                                value={adminSortBy} 
                                                                onChange={e => setAdminSortBy(e.target.value)}
                                                                className="px-2 py-1.5 text-xs border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer"
                                                            >
                                                                <option value="etd">Sort: ETD</option>
                                                                <option value="vessel">Sort: Name</option>
                                                                <option value="pod">Sort: POD</option>
                                                            </select>

                                                            {selectedForText.size > 0 && <button onClick={() => {setSelectedForText(new Set()); setSelectionDestCode(null);}} className="text-xs bg-rose-50 text-rose-600 px-3 py-1.5 rounded-lg font-medium hover:bg-rose-100 transition-colors">Clear ({selectedForText.size})</button>}
                                                        </div>
                                                    </div>
                                                    <div className="overflow-x-auto">
                                                        <table className="w-full text-sm text-left">
                                                            <thead className="bg-slate-50 text-slate-500 font-semibold uppercase text-xs tracking-wider">
                                                                <tr>
                                                                    <th className="px-4 py-3 w-8 text-center">Select</th>
                                                                    <th className="px-4 py-3">Vessel</th>
                                                                    <th className="px-4 py-3">ETD</th>
                                                                    <th className="px-4 py-3">POD</th>
                                                                    <th className="px-4 py-3">ETA</th>
                                                                    <th className="px-4 py-3 text-right">Action</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody className="divide-y divide-slate-100">
                                                                {adminFilteredEntries.length === 0 ? (
                                                                    <tr><td colSpan={6} className="p-8 text-center text-slate-400 italic">No matches found.</td></tr>
                                                                ) : (
                                                                    adminFilteredEntries.map((entry) => {
                                                                        const isSelected = selectedForText.has(entry.id);
                                                                        const isDisabled = selectionDestCode && entry.destCode !== selectionDestCode && !isSelected;
                                                                        const isEditing = editingId === entry.id;
                                                                        return (
                                                                            <tr key={entry.id} className={`group transition-all ${isSelected ? 'bg-blue-50/60' : 'hover:bg-slate-50'} ${isDisabled ? 'opacity-40 grayscale' : ''} ${isEditing ? 'bg-blue-50/30' : ''}`}>
                                                                                <td className="px-4 py-4 text-center">
                                                                                    <button onClick={() => toggleSelection(entry)} disabled={isDisabled} className={`w-5 h-5 rounded-md border flex items-center justify-center transition-all ${isSelected ? 'bg-blue-600 border-blue-600 text-white scale-110 shadow-sm' : 'border-slate-300 text-transparent hover:border-blue-400'}`}>
                                                                                        <Icons.CheckCircle size={14} />
                                                                                    </button>
                                                                                </td>
                                                                                <td className="px-4 py-4">
                                                                                    <div className="font-bold text-slate-800">{entry.vessel}</div>
                                                                                    <div className="text-xs text-slate-500 font-mono mt-0.5">{entry.voyage}</div>
                                                                                </td>
                                                                                <td className="px-4 py-4 text-slate-600 font-medium text-xs whitespace-nowrap">{formatDate(entry.etdHkg)}</td>
                                                                                <td className="px-4 py-4 text-slate-600 font-bold text-xs">{entry.destCode}</td>
                                                                                <td className="px-4 py-4 text-slate-600 font-medium text-xs whitespace-nowrap">{formatDate(entry.etaDest)}</td>
                                                                                <td className="px-4 py-4 text-right">
                                                                                    <div className="flex justify-end gap-2">
                                                                                        <button onClick={() => handleEdit(entry)} className="text-slate-300 hover:text-blue-500 p-2 rounded-lg hover:bg-blue-50 transition-all"><Icons.Edit size={18}/></button>
                                                                                        <button onClick={() => removeEntry(entry.id)} className="text-slate-300 hover:text-rose-500 p-2 rounded-lg hover:bg-rose-50 transition-all"><Icons.Trash2 size={18} /></button>
                                                                                    </div>
                                                                                </td>
                                                                            </tr>
                                                                        );
                                                                    })
                                                                )}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        <div className="lg:col-span-5 space-y-6">
                                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                                                <div className="flex items-center gap-2 mb-4 text-slate-800"><Icons.Settings size={20} className="text-blue-600" /><h3 className="font-bold">Output Config</h3></div>
                                                <div className="flex flex-wrap gap-2">
                                                    {['showVesselLine:Vessel', 'showCarrier:Carrier', 'showEtd:ETD', 'showEta:ETA', 'showCfs:CFS', 'showLoad:Load', 'showTt:TT'].map(opt => {
                                                        const [key, label] = opt.split(':');
                                                        return (
                                                            <button key={key} onClick={() => setDisplayConfig(p => ({...p, [key]: !p[key]}))} 
                                                                className={`px-3 py-1.5 text-xs font-semibold rounded-lg border transition-all ${displayConfig[key] ? 'bg-blue-50 border-blue-200 text-blue-700 shadow-sm' : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'}`}>
                                                                {label}
                                                            </button>
                                                        )
                                                    })}
                                                </div>
                                            </div>
                                            <div className="bg-slate-900 rounded-2xl shadow-xl border border-slate-800 overflow-hidden flex flex-col h-[500px]">
                                                <div className="bg-slate-950 px-5 py-4 flex justify-between items-center border-b border-slate-800">
                                                    <span className="font-mono text-xs text-blue-400 font-bold uppercase tracking-wider flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div> Output Preview</span>
                                                    <button onClick={copyToClipboard} className={`text-xs font-bold px-3 py-1.5 rounded-lg transition-all ${copied ? 'bg-emerald-500 text-white' : 'bg-blue-600 text-white hover:bg-blue-500'}`}>{copied ? 'COPIED!' : 'COPY TEXT'}</button>
                                                </div>
                                                <div className="relative flex-grow bg-slate-900">
                                                    <textarea readOnly value={generatedText} className="w-full h-full bg-transparent p-6 text-slate-300 font-mono text-xs leading-relaxed focus:outline-none resize-none relative z-10" />
                                                    {generatedText === '' && <div className="absolute inset-0 flex items-center justify-center text-slate-700 text-sm font-mono z-0">Ready for data...</div>}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'schedule' && (
                                    <div className="space-y-8 animate-fade pb-12">
                                        {/* Destination Filters */}
                                        <div className="flex items-center gap-2 overflow-x-auto pb-4 scrollbar-hide">
                                            <button onClick={() => { setActiveScheduleFilter('ALL'); setSelectedEntryId(null); }} className={`flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-bold transition-all shadow-sm border ${activeScheduleFilter === 'ALL' ? 'bg-slate-800 text-white border-slate-800 ring-2 ring-slate-200' : 'bg-white text-slate-600 border-slate-200 hover:border-blue-300 hover:text-blue-600'}`}>
                                                <span>All Ports</span> <span className={`px-1.5 py-0.5 rounded-md text-[10px] ${activeScheduleFilter === 'ALL' ? 'bg-white/20 text-white' : 'bg-slate-100 text-slate-500'}`}>{visibleEntries.length}</span>
                                            </button>
                                            <div className="w-px h-8 bg-slate-200 mx-2"></div>
                                            {uniqueDestinations.map(dest => (
                                                <button key={dest} onClick={() => { setActiveScheduleFilter(dest); setSelectedEntryId(null); }} className={`flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-bold transition-all shadow-sm border ${activeScheduleFilter === dest ? 'bg-blue-600 text-white border-blue-600 ring-2 ring-blue-100' : 'bg-white text-slate-600 border-slate-200 hover:border-blue-300 hover:text-blue-600'}`}>
                                                    <Icons.MapPin size={16} className={activeScheduleFilter === dest ? 'text-white' : 'text-slate-400'} /> <span>{dest}</span> 
                                                </button>
                                            ))}
                                        </div>

                                        {/* Main Table Card */}
                                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                            <div className="overflow-x-auto">
                                                <table className="w-full">
                                                    <thead>
                                                        <tr className="bg-slate-50 border-b border-slate-200 text-xs uppercase tracking-wider text-slate-500 font-bold">
                                                            <th className="px-6 py-4 w-20 text-center bg-slate-100/50">Wk</th>
                                                            <th className="px-6 py-4 text-left">Vessel / Voyage</th>
                                                            <th className="px-6 py-4 text-left">Closing</th>
                                                            {/* UPDATED: Conditionally show Load column */}
                                                            {isAdmin && <th className="px-6 py-4 text-left">Load</th>}
                                                            <th className="px-6 py-4 text-left">ETD HKG</th>
                                                            <th className="px-6 py-4 text-left">{activeScheduleFilter === 'ALL' ? 'ETA / POD' : `ETA ${activeScheduleFilter}`}</th>
                                                            <th className="px-6 py-4 text-left">Carrier</th>
                                                            <th className="px-6 py-4 text-center">T.T</th>
                                                            {isAdmin && <th className="px-6 py-4 w-10"></th>}
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-100 text-sm font-medium">
                                                        {filteredEntries.length === 0 ? (
                                                            <tr><td colSpan={isAdmin ? 8 : 7} className="p-16 text-center text-slate-400 italic">No recent schedules found.</td></tr>
                                                        ) : (
                                                            filteredEntries.map((entry) => (
                                                                <tr key={entry.id} onClick={() => setSelectedEntryId(entry.id)} 
                                                                    className={`group cursor-pointer transition-all hover:bg-slate-50 ${selectedEntryId === entry.id ? 'bg-blue-50/60 border-l-4 border-l-blue-600' : 'border-l-4 border-l-transparent'}`}>
                                                                    <td className="px-6 py-4 text-center">
                                                                        <span className="text-slate-400 text-xs">#</span>{getWeekNumber(entry.etdHkg)}
                                                                    </td>
                                                                    <td className="px-6 py-4">
                                                                        <div className="font-bold text-slate-800 text-base">{entry.vessel}</div>
                                                                        <div className="text-xs text-slate-500 font-mono mt-1 bg-slate-100 inline-block px-1.5 py-0.5 rounded">{entry.voyage}</div>
                                                                    </td>
                                                                    <td className="px-6 py-4 text-slate-600 tabular-nums">{formatDate(entry.cfsClosing)}</td>
                                                                    {/* UPDATED: Conditionally show Load data */}
                                                                    {isAdmin && <td className="px-6 py-4 text-slate-600 tabular-nums">{formatDate(entry.loadingDate)}</td>}
                                                                    <td className="px-6 py-4 text-blue-700 font-bold tabular-nums">{formatDate(entry.etdHkg)}</td>
                                                                    <td className="px-6 py-4">
                                                                        <div className="flex items-center gap-2">
                                                                            <span className="tabular-nums text-slate-700">{formatDate(entry.etaDest)}</span>
                                                                            {activeScheduleFilter === 'ALL' && <span className="text-[10px] font-bold bg-slate-200 text-slate-700 px-1.5 py-0.5 rounded">{entry.destCode}</span>}
                                                                        </div>
                                                                    </td>
                                                                    <td className="px-6 py-4">
                                                                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-indigo-50 text-indigo-700 border border-indigo-100">
                                                                            {entry.carrier}
                                                                        </span>
                                                                    </td>
                                                                    <td className="px-6 py-4 text-center">
                                                                        <span className="text-slate-600 font-bold bg-slate-100 px-2 py-1 rounded-md">{entry.transitTime}</span>
                                                                    </td>
                                                                    {isAdmin && (
                                                                        <td className="px-6 py-4 text-center">
                                                                            <button onClick={(e) => {e.stopPropagation(); removeEntry(entry.id);}} className="text-slate-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icons.Trash2 size={18}/></button>
                                                                        </td>
                                                                    )}
                                                                </tr>
                                                            ))
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div className="pt-4">
                                             <CalendarWidget entry={selectedEntry} isAdmin={isAdmin} />
                                        </div>
                                    </div>
                                )}

                                <Modal isOpen={showAdminModal} onClose={() => setShowAdminModal(false)} title="Admin Access">
                                    <form onSubmit={handleAdminLogin} className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-bold text-slate-700 mb-2">Password</label>
                                            <input type="password" value={adminPassword} onChange={(e) => setAdminPassword(e.target.value)}
                                                className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                                                placeholder="" autoFocus />
                                        </div>
                                        <button type="submit" className="w-full bg-slate-900 text-white font-bold py-3 px-4 rounded-xl hover:bg-black transition-colors shadow-lg">
                                            Unlock Editor
                                        </button>
                                    </form>
                                </Modal>
                            </>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<VesselScheduleApp />);
    </script>
</body>
</html>
