<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vessel Schedule Manager</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        textarea, pre, code { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 300ms, transform 300ms; }
        
        /* Calculator Specific Styles */
        .calc-input { font-variant-numeric: slashed-zero tabular-nums; }
        .calc-section { transition: all 0.2s; }
        .calc-section:hover { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        
        /* Report Styles for InnerHTML */
        .xl-wrapper { margin-top: 10px; }
        .xl-info-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px 20px; margin-bottom: 20px; border-radius: 6px; font-size: 13px; color: #64748b; display: flex; gap: 20px; }
        .xl-info-box strong { color: #0f172a; }
        .xl-table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; } /* Fixed layout for alignment */
        .xl-header { background: #f8fafc; color: #64748b; font-weight: 600; text-align: left; padding: 12px 4px; border-bottom: 1px solid #e2e8f0; text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .xl-row td { padding: 8px 4px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; color: #334155; overflow-wrap: break-word; font-size: 12px; }
        .xl-row:nth-child(even) { background-color: #fcfcfc; }
        .col-amt { text-align: right; font-weight: 600; font-family: 'Inter', sans-serif; font-variant-numeric: slashed-zero tabular-nums; color: #0f172a; }
        .min-highlight { font-weight: 700; color: #0ea5e9; font-size: 10px; background: #e0f2fe; padding: 1px 4px; border-radius: 4px; margin-left: 4px; }
        .calc-subtext { display: block; font-size: 11px; color: #94a3b8; margin-top: 2px; }
        
        .comparison-container { display: flex; gap: 24px; }
        .comparison-col { flex: 1; display: flex; flex-direction: column; background: white; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .table-title { padding: 12px 16px; background: #fff; font-weight: 700; font-size: 14px; color: #0f172a; border-bottom: 1px solid #e2e8f0; }
        
        @media (max-width: 768px) { .comparison-container { flex-direction: column; } }

        /* Input focus rings */
        input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        /* Smooth width transition for main area */
        .transition-width { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <div id="root"></div>

    <!-- Firebase Initialization -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURATION
        const firebaseConfig = {
          apiKey: "AIzaSyCChjLWOazjQzLp6JSvdFw3ocWb097Qqlc",
          authDomain: "vsltrker.firebaseapp.com",
          projectId: "vsltrker",
          storageBucket: "vsltrker.firebasestorage.app",
          messagingSenderId: "623033107164",
          appId: "1:623033107164:web:fa7ccf7325346e58536a19",
          measurementId: "G-LNYMSYRWP8"
        };

        const appId = 'vessel-schedule-app'; 

        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);

                window.db = db;
                window.auth = auth;
                window.googleProvider = new GoogleAuthProvider();
                window.signInWithPopup = signInWithPopup;
                window.signOut = signOut;
                window.signInAnonymously = signInAnonymously;
                window.collection = collection;
                window.addDoc = addDoc;
                window.updateDoc = updateDoc;
                window.deleteDoc = deleteDoc;
                window.doc = doc;
                window.getDoc = getDoc;
                window.onSnapshot = onSnapshot;
                window.appId = appId;
                window.onAuthStateChanged = onAuthStateChanged;
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useReducer } = React;

        // --- ICONS ---
        const IconWrapper = ({ children, size = 20, className = "", onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick}>{children}</svg>
        );
        const Icons = {
            Plus: (props) => <IconWrapper {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>,
            Trash2: (props) => <IconWrapper {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>,
            Edit: (props) => <IconWrapper {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconWrapper>,
            Clipboard: (props) => <IconWrapper {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></IconWrapper>,
            Settings: (props) => <IconWrapper {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>,
            Ship: (props) => <IconWrapper {...props}><path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M19.38 20A11.6 11.6 0 0 0 21 14l-9-4-9 4c0 2.9.9 5.8 2.38 8"/><path d="M12 10V4"/><path d="M8 8v1"/><path d="M16 8v1"/></IconWrapper>,
            Calendar: (props) => <IconWrapper {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconWrapper>,
            LayoutList: (props) => <IconWrapper {...props}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/><path d="M14 4h7"/><path d="M14 9h7"/><path d="M14 15h7"/><path d="M14 20h7"/></IconWrapper>,
            Table: (props) => <IconWrapper {...props}><path d="M12 3v18"/><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/></IconWrapper>,
            MapPin: (props) => <IconWrapper {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconWrapper>,
            ChevronLeft: (props) => <IconWrapper {...props}><path d="m15 18-6-6 6-6"/></IconWrapper>,
            ChevronRight: (props) => <IconWrapper {...props}><path d="m9 18 6-6-6-6"/></IconWrapper>,
            Info: (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconWrapper>,
            CheckCircle: (props) => <IconWrapper {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconWrapper>,
            Lock: (props) => <IconWrapper {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconWrapper>,
            Unlock: (props) => <IconWrapper {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></IconWrapper>,
            X: (props) => <IconWrapper {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>,
            Search: (props) => <IconWrapper {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconWrapper>,
            Google: (props) => <IconWrapper {...props}><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2c2.4 0 4.6 0.9 6.3 2.4l-3 2.9C14.2 6.6 13.2 6 12 6c-3.3 0-6 2.7-6 6s2.7 6 6 6c2.9 0 5.3-2 5.9-4.8H12V10.2h10c0.1 0.6 0.2 1.2 0.2 1.8 0 5.6-4.6 10-10.2 10z"/></IconWrapper>,
            User: (props) => <IconWrapper {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconWrapper>,
            Calculator: (props) => <IconWrapper {...props}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconWrapper>,
            Save: (props) => <IconWrapper {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>,
            Download: (props) => <IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconWrapper>,
            Scroll: (props) => <IconWrapper {...props}><path d="M8 19h8a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2z"/><path d="M12 11v4"/><path d="M8 7h8"/></IconWrapper>,
            Refresh: (props) => <IconWrapper {...props}><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></IconWrapper>,
        };

        // --- SHARED COMPONENTS ---
        const InputField = ({ label, name, type = "text", placeholder, value, onChange, required = false, className = "" }) => (
            <div className={`flex flex-col ${className}`}>
                <label className="text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">{label}</label>
                <input type={type} name={name} value={value} onChange={onChange} placeholder={placeholder} required={required} className="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-slate-800 text-sm transition-all shadow-sm" />
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm animate-in fade-in zoom-in duration-200 transform scale-100">
                        <div className="flex justify-between items-center mb-6 border-b border-slate-100 pb-2">
                            <h3 className="text-lg font-bold text-slate-800">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 transition-colors"><Icons.X size={20}/></button>
                        </div>
                        {children}
                    </div>
                </div>
            );
        };

        const SmartDateInput = ({ label, name, value, onChange, placeholder = "DD/MM/YY", required = false, className = "" }) => {
            const [displayValue, setDisplayValue] = useState('');
            const [error, setError] = useState(false);
            useEffect(() => {
                if (value) { const [y, m, d] = value.split('-'); if (y && m && d) setDisplayValue(`${d}/${m}/${y.slice(-2)}`); } else setDisplayValue(''); setError(false);
            }, [value]);
            const parseAndSubmit = (inputVal) => {
                if (!inputVal.trim()) { onChange({ target: { name, value: '' } }); return; }
                let d, m, y;
                const clean = inputVal.replace(/[^0-9]/g, ' ').trim().split(/\s+/);
                if (clean.length === 1 && clean[0].length === 6) { d = clean[0].substring(0, 2); m = clean[0].substring(2, 4); y = clean[0].substring(4, 6); } 
                else if (clean.length === 3) { [d, m, y] = clean; }
                if (d && m && y) {
                    let numY = parseInt(y, 10); let numM = parseInt(m, 10); let numD = parseInt(d, 10);
                    if (numY < 100) numY += 2000;
                    const dateObj = new Date(numY, numM - 1, numD);
                    if (dateObj.getFullYear() === numY && dateObj.getMonth() === numM - 1 && dateObj.getDate() === numD) {
                        const localIsoDate = `${numY}-${String(numM).padStart(2, '0')}-${String(numD).padStart(2, '0')}`;
                        onChange({ target: { name, value: localIsoDate } });
                        setDisplayValue(`${numD.toString().padStart(2, '0')}/${numM.toString().padStart(2, '0')}/${numY.toString().slice(-2)}`);
                        setError(false); return;
                    }
                }
                setError(true);
            };
            return (
                <div className={`flex flex-col ${className}`}>
                    <label className="text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide flex justify-between">{label}{error && <span className="text-rose-500 normal-case text-[10px] font-medium animate-pulse">Invalid</span>}</label>
                    <div className="relative group">
                        <input type="text" name={name} value={displayValue} onChange={(e) => setDisplayValue(e.target.value)} onBlur={() => parseAndSubmit(displayValue)} onKeyDown={(e) => e.key === 'Enter' && parseAndSubmit(displayValue)} placeholder={placeholder} required={required} className={`w-full px-3 py-2 bg-white border rounded-lg focus:outline-none focus:ring-2 focus:bg-white text-slate-800 text-sm transition-all shadow-sm ${error ? 'border-rose-300 ring-rose-100 focus:ring-rose-200' : 'border-slate-200 focus:ring-blue-500 focus:border-blue-500'}`} />
                        <div className="absolute right-3 top-2.5 pointer-events-none text-slate-400 group-hover:text-blue-500 transition-colors"><Icons.Calendar size={14} /></div>
                    </div>
                </div>
            );
        };

        const CalendarWidget = ({ entry, isAdmin }) => { 
            const [currentDate, setCurrentDate] = useState(new Date());
            useEffect(() => { if (entry) { const initialDateStr = entry.cfsClosing || entry.loadingDate || entry.etdHkg || entry.etaDest; if (initialDateStr) { const [y,m,d] = initialDateStr.split('-').map(Number); setCurrentDate(new Date(y, m-1, d)); } } }, [entry]);
            if (!entry) return <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-12 text-center text-slate-400 flex flex-col items-center gap-4"><div className="opacity-20"><Icons.Calendar size={48} /></div><p>Select a vessel to view calendar.</p></div>;
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
            const changeMonth = (offset) => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1));
            const events = [
                { type: 'CFS', date: entry.cfsClosing, color: 'bg-rose-100 text-rose-700 border-rose-200' },
                ...(isAdmin ? [{ type: 'LOAD', date: entry.loadingDate, color: 'bg-amber-100 text-amber-700 border-amber-200' }] : []),
                { type: 'ETD', date: entry.etdHkg, color: 'bg-blue-100 text-blue-700 border-blue-200' },
                { type: 'ETA', date: entry.etaDest, color: 'bg-emerald-100 text-emerald-700 border-emerald-200' }
            ].filter(e => e.date);
            const days = [];
            for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} className="h-24 bg-slate-50/50 border-r border-b border-slate-100"></div>);
            for (let d = 1; d <= daysInMonth; d++) {
                const dayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), d);
                const currentDayStr = `${dayDate.getFullYear()}-${String(dayDate.getMonth()+1).padStart(2,'0')}-${String(dayDate.getDate()).padStart(2,'0')}`;
                const dayEvents = events.filter(e => e.date === currentDayStr);
                days.push(
                    <div key={d} className="h-24 border-r border-b border-slate-100 p-1 relative hover:bg-slate-50 transition-colors group bg-white">
                        <span className={`text-xs font-semibold p-1.5 rounded-full inline-block w-6 h-6 text-center leading-3 ${dayEvents.length > 0 ? 'bg-slate-800 text-white shadow-sm' : 'text-slate-400'}`}>{d}</span>
                        <div className="flex flex-col gap-1 mt-1">{dayEvents.map((ev, idx) => <div key={idx} className={`text-[10px] px-1.5 py-0.5 rounded border ${ev.color} font-bold shadow-sm truncate`}>{ev.type}</div>)}</div>
                    </div>
                );
            }
            return (
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="p-4 border-b border-slate-200 flex items-center justify-between bg-slate-50/50">
                        <div className="flex items-center gap-3"><div className="bg-gradient-to-br from-blue-600 to-indigo-700 p-2.5 rounded-xl text-white shadow-md"><Icons.Calendar size={20} /></div><div><h3 className="font-bold text-slate-800">{entry.vessel}</h3><p className="text-xs text-slate-500 font-medium">Logistics Timeline</p></div></div>
                        <div className="flex items-center bg-white rounded-lg border border-slate-200 shadow-sm">
                            <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-slate-50 text-slate-600 rounded-l-lg transition-colors"><Icons.ChevronLeft size={16} /></button>
                            <span className="px-4 text-sm font-semibold min-w-[140px] text-center text-slate-700">{currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })}</span>
                            <button onClick={() => changeMonth(1)} className="p-2 hover:bg-slate-50 text-slate-600 rounded-r-lg transition-colors"><Icons.ChevronRight size={16} /></button>
                        </div>
                    </div>
                    <div className="grid grid-cols-7 bg-slate-50 text-[10px] font-bold text-slate-400 text-center py-2.5 border-b border-slate-200 uppercase tracking-widest"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
                    <div className="grid grid-cols-7 bg-white">{days}</div>
                </div>
            );
        };

        // --- CALCULATOR LOGIC (Pure JS) ---
        const CURRENCIES = ['EUR', 'USD', 'HKD', 'RMB'];
        const DEFAULT_PRESETS = {
            "SEA MASTER STANDARD": { "sections": [{ "type": "lcl", "data": { "rt": 15, "ton": 30, "min": 30, "curr": "EUR" } }, { "type": "pier", "data": { "high": 13.4, "heavy": 66.69, "light": 83.74, "min": 74.4, "curr": "EUR" } }], "items": [{ "name": "GSC", "price": 5.5, "unit": "RT", "curr": "EUR", "min_type": "None" }, { "name": "ERS", "price": 24, "unit": "RT", "curr": "EUR", "min_type": "None" }, { "name": "ATB FEE", "price": 10.5, "unit": "BL", "curr": "EUR", "min_type": "None" }, { "name": "EECS", "price": 3.5, "unit": "BL", "curr": "EUR", "min_type": "None" }, { "name": "DO", "price": 65, "unit": "BL", "curr": "EUR", "min_type": "None" }, { "name": "ANTI TERROR", "price": 5.5, "unit": "BL", "curr": "EUR", "min_type": "None" }, { "name": "SECURE RELEASE", "price": 7, "unit": "BL", "curr": "EUR", "min_type": "None" }], "title": "SEA MASTER STANDARD" },
            "EMPTY": { "sections": [], "items": [], "title": "Empty Template" }
        };

        function calculateCharges(cbm, kgs, pkgs, sections, extra_items) {
            let rt = Math.max(cbm, kgs / 1000.0);
            let tons = kgs / 1000.0;
            let avg_pkg_weight = (pkgs > 0) ? (kgs / pkgs) : 0;
            let rows = [];

            if(!sections) sections = [];
            if(!extra_items) extra_items = [];

            sections.forEach(section => {
                let d = section.data;
                let s_curr = d.curr || 'EUR';

                if (section.type === 'lcl') {
                    let calc_cbm = d.rt * cbm; 
                    let calc_ton = d.ton * tons;
                    let base_calc = Math.max(calc_cbm, calc_ton);
                    let lcl_min = d.min || 0.0;
                    let lcl_total = 0;
                    let desc_line2 = "";

                    if (base_calc < lcl_min) {
                        lcl_total = lcl_min;
                        desc_line2 = `<span class="min-highlight">[MIN ${lcl_min.toFixed(2)}]</span>`;
                    } else {
                        lcl_total = base_calc;
                        desc_line2 = calc_cbm >= calc_ton ? `<span class="min-highlight">[CBM RATE]</span>` : `<span class="min-highlight">[TON RATE]</span>`;
                    }
                    rows.push({'item': 'LCL CHARGES', 'desc': `${s_curr} ${d.rt}/CBM OR ${d.ton}/TON | MIN ${lcl_min.toFixed(2)} ${desc_line2}`, 'curr': s_curr, 'amount': lcl_total});
                }
                else if (section.type === 'pier') {
                    let effective_tons = Math.max(tons, 1.0);
                    let rate_weight = (avg_pkg_weight > 20) ? d.heavy : d.light;
                    let amt_weight = rate_weight * effective_tons;
                    let amt_high = (rt > 5 && (tons > 0 ? (cbm/tons) : 0) >= 5) ? (d.high * rt) : 0.0;
                    let calculated_amt = Math.max(amt_high, amt_weight);
                    let pier_total = 0.0;
                    let desc_line2 = "";

                    if (calculated_amt < d.min) {
                        pier_total = d.min;
                        desc_line2 = `<span class="min-highlight">[MIN ${d.min.toFixed(2)}]</span>`;
                    } else {
                        pier_total = calculated_amt;
                        desc_line2 = amt_high > amt_weight ? `<span class="min-highlight">[HIGH VOL]</span>` : (avg_pkg_weight > 20 ? `<span class="min-highlight">[HEAVY]</span>` : `<span class="min-highlight">[LIGHT]</span>`);
                    }
                    rows.push({'item': 'PIER CHARGES', 'desc': `${s_curr} >20k:${d.heavy}/T | <20k:${d.light}/T | HiVol:${d.high}/RT | MIN:${d.min.toFixed(2)} ${desc_line2}`, 'curr': s_curr, 'amount': pier_total});
                }
                else if (section.type === 'stor') {
                    let s_rate = d.rate;
                    let s_min_days = parseInt(d.min_days);
                    let s_unit = d.unit || 'RT';
                    let actual_days = d.days || 0;
                    if (s_rate > 0 && actual_days > 0) {
                        let billable_days = Math.max(actual_days, s_min_days);
                        let qty_used = s_unit === 'RT' ? rt : s_unit === 'CBM' ? cbm : s_unit === 'TON' ? tons : s_unit === 'PKG' ? pkgs : s_unit === 'FLAT' ? 1.0 : rt;
                        let stor_amt = s_rate * qty_used * billable_days;
                        let min_text = actual_days < s_min_days ? `<span class="min-highlight">[MIN ${s_min_days} DAYS]</span>` : ``;
                        rows.push({'item': 'STORAGE', 'desc': `${s_curr} ${s_rate}/${s_unit}/DAY ${min_text}`, 'curr': s_curr, 'amount': stor_amt});
                    }
                }
            });

            extra_items.forEach(item => {
                let price = item.price;
                let unit = item.unit;
                let curr = item.curr;
                let min_type = item.min_type || 'None';
                let min_val = item.min_val || 0.0;
                
                let qty_used = 0.0;
                if (['FLAT', 'SHPT', 'BL'].includes(unit)) qty_used = 1.0;
                else if (['RT', 'W/M'].includes(unit)) qty_used = rt;
                else if (unit === 'CBM') qty_used = cbm;
                else if (unit === 'TON') qty_used = tons;
                else if (unit === 'PKG') qty_used = pkgs;
                
                let billable_qty = ['RT', 'W/M', 'CBM', 'TON'].includes(unit) ? Math.max(qty_used, 1.0) : qty_used;
                if (min_type === 'Unit' && ['RT', 'W/M', 'CBM', 'TON'].includes(unit)) billable_qty = Math.max(billable_qty, min_val);

                let line_total = price * billable_qty;
                if (min_type === 'Amt' && min_val > line_total) line_total = min_val;

                let desc = `${curr} ${price}/${unit}`;
                if (min_type === 'Amt') desc += ` | MIN ${curr} ${min_val.toFixed(2)}`;
                else if (min_type === 'Unit' && min_val > 1) desc += ` | MIN ${min_val} ${unit}`;

                if (line_total > 0) rows.push({'item': item.name.toUpperCase(), 'desc': desc, 'curr': curr, 'amount': line_total});
            });

            rows.sort((a, b) => a.curr.localeCompare(b.curr));
            
            let totals = {};
            CURRENCIES.forEach(c => totals[c] = 0.0);
            rows.forEach(r => { if (totals[r.curr] !== undefined) totals[r.curr] += r.amount; });

            return { rows: rows, totals: totals, meta: {cbm, kgs, pkgs} };
        }

        function generateReportHTML(res_std, res_req, view_mode, title_std, title_req) {
            let active_currencies = CURRENCIES.filter(c => res_std.totals[c] > 0 || res_req.totals[c] > 0);
            let meta = res_std.meta;
            let cargo_html = `<div class="xl-info-box"><strong>SHIPMENT DETAILS:</strong>&nbsp;&nbsp; CBM: ${meta.cbm.toFixed(3)} &nbsp;|&nbsp; KGS: ${meta.kgs.toFixed(3)} &nbsp;|&nbsp; PKGS: ${meta.pkgs}</div>`;

            // PADDING LOGIC (Visual padding only, does not affect calculation)
            let rows_std = [...res_std.rows];
            let rows_req = [...res_req.rows];

            // In Comparison mode, we need to ensure both sides have the SAME number of visual rows (Items + Pad)
            // so that the Footer Table starts at the exact same Y-position.
            if (view_mode === 'Comparison') {
                let max_len = Math.max(rows_std.length, rows_req.length);
                while (rows_std.length < max_len) rows_std.push({ is_pad: true });
                while (rows_req.length < max_len) rows_req.push({ is_pad: true });
            }

            const buildColumnHTML = (rows, totals, title, show_diff) => {
                // 1. Items Table Body
                let rows_html = rows.map(r => {
                    if (r.is_pad) return `<tr class="xl-row"><td colspan="4">&nbsp;</td></tr>`;
                    return `<tr class="xl-row"><td class="col-item">${r.item}</td><td class="col-desc">${r.desc}</td><td class="col-curr">${r.curr}</td><td class="col-amt">${r.amount.toFixed(2)}</td></tr>`;
                }).join('');

                if (!rows_html) rows_html = `<tr class="xl-row"><td colspan="4" style="text-align:center; padding:20px; color:#cbd5e1;">No charges</td></tr>`;

                // 2. Footer Table Body (Totals)
                let footer_html = "";
                if (active_currencies.length > 0) {
                    active_currencies.forEach(c => {
                        let val = totals[c] || 0;
                        // Show if >0 OR if we are in comparison mode (to maintain alignment with other side)
                        if (val > 0 || view_mode === 'Comparison') { 
                             footer_html += `
                                <tr class="xl-row" style="background-color: #f8fafc; font-weight: 700;">
                                    <td colspan="2"></td>
                                    <td class="col-curr" style="color: #64748b;">TOTAL ${c}</td>
                                    <td class="col-amt" style="color: #0f172a;">${val.toFixed(2)}</td>
                                </tr>`;
                        }
                    });
                } else {
                     footer_html += `
                        <tr class="xl-row" style="background-color: #f8fafc; font-weight: 700;">
                            <td colspan="2"></td>
                            <td class="col-curr" style="color: #64748b;">TOTAL</td>
                            <td class="col-amt" style="color: #0f172a;">0.00</td>
                        </tr>`;
                }

                // 3. Diff Table Body (Difference) - SEPARATE TABLE or SPACER ROW
                let diff_html = "";
                // Always generate diff content for spacing purposes in comparison mode
                if (view_mode === 'Comparison') {
                    active_currencies.forEach(c => {
                        let diff = (res_std.totals[c] || 0) - (res_req.totals[c] || 0);
                        let sign = diff >= 0 ? "+" : "";
                        let color = diff >= 0 ? "#b45309" : "#059669"; 
                        let bg = diff >= 0 ? "#fff7ed" : "#ecfdf5";
                        
                        diff_html += `
                            <tr class="xl-row" style="background-color: ${bg}; border-top: 1px dashed ${color}; font-weight: 700; color: ${color};">
                                <td colspan="2"></td>
                                <td class="col-curr">DIFF ${c}</td>
                                <td class="col-amt">${sign}${diff.toFixed(2)}</td>
                            </tr>`;
                    });
                }

                // Use fixed col widths to ensure alignment across separate tables
                const colGroup = `<colgroup><col style="width:22%"><col style="width:48%"><col style="width:12%"><col style="width:18%"></colgroup>`;

                return `<div class="comparison-col">
                            <div class="table-title">${title}</div>
                            
                            <!-- Items Table (Flex Grow to push footer down) -->
                            <div style="flex: 1;">
                                <table class="xl-table">
                                    ${colGroup}
                                    <thead>
                                        <tr>
                                            <th class="xl-header">Item</th>
                                            <th class="xl-header">Desc</th>
                                            <th class="xl-header">Cur</th>
                                            <th class="xl-header col-amt">Amt</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${rows_html}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Footer Table (Pinned to bottom) -->
                            <div style="border-top: 2px solid #e2e8f0;">
                                <table class="xl-table">
                                    ${colGroup}
                                    <tbody>
                                        ${footer_html}
                                    </tbody>
                                </table>
                            </div>
                            
                            ${diff_html ? `
                            <!-- Spacer -->
                            <div style="height: 40px;"></div> 
                            
                            <!-- Diff Table (Hidden on left side if desired, but we show diff logic on both or just one. 
                                 Logic: if show_diff is true, show it visible. If false, show it invisible to reserve space.) 
                            -->
                            <div style="border-top: 1px dashed #fdba74; ${show_diff ? '' : 'visibility: hidden;'}">
                                <table class="xl-table">
                                    ${colGroup}
                                    <tbody>
                                        ${diff_html}
                                    </tbody>
                                </table>
                            </div>
                            ` : ''}
                        </div>`;
            };

            let left = (view_mode !== 'Requested') ? buildColumnHTML(rows_std, res_std.totals, title_std, false) : "";
            // Right side shows diff if we are in comparison mode
            let right = (view_mode !== 'Standard') ? buildColumnHTML(rows_req, res_req.totals, title_req, view_mode === 'Comparison') : "";

            let container_html = "";
            if (view_mode === 'Comparison') {
                container_html = `<div class="comparison-container">${left}${right}</div>`;
            } else {
                container_html = `<div style="width:100%;">${left || right}</div>`;
            }

            return `<div class='xl-wrapper'>${cargo_html}${container_html}</div>`;
        }

        // --- CALCULATOR COMPONENT ---
        const DestCalcTool = () => {
            const [globals, setGlobals] = useState({ ref: '', cbm: 3.0, kgs: 250, pkgs: 3, viewMode: 'Comparison' });
            const [stdData, setStdData] = useState({ sections: [], items: [], title: 'Standard' });
            const [reqData, setReqData] = useState({ sections: [], items: [], title: 'Requested' });
            const [mgrData, setMgrData] = useState({ sections: [], items: [], title: '' }); // MANAGER DATA
            const [presets, setPresets] = useState(DEFAULT_PRESETS);
            const [history, setHistory] = useState([]);
            const [activeSubTab, setActiveSubTab] = useState('std');
            const [htmlOutput, setHtmlOutput] = useState('');
            const [selectedPresetName, setSelectedPresetName] = useState('Create New...');
            const [showSidebar, setShowSidebar] = useState(true);

            useEffect(() => {
                const saved = localStorage.getItem('dest_calc_v1');
                if (saved) {
                    const d = JSON.parse(saved);
                    setGlobals(d.globals || { ref: '', cbm: 3, kgs: 250, pkgs: 3, viewMode: 'Comparison' });
                    setStdData(d.std || { sections: [], items: [], title: 'Standard' });
                    setReqData(d.req || { sections: [], items: [], title: 'Requested' });
                    setPresets({ ...DEFAULT_PRESETS, ...(d.presets || {}) });
                    setHistory(d.history || []);
                } else {
                    // Initial load default
                    setStdData(JSON.parse(JSON.stringify(DEFAULT_PRESETS["SEA MASTER STANDARD"])));
                }
                // Initial calculation on mount
                setTimeout(runReportCalculation, 100);
            }, []);

            // Only save to local storage on changes, do NOT auto-calculate report
            useEffect(() => {
                localStorage.setItem('dest_calc_v1', JSON.stringify({ globals, std: stdData, req: reqData, presets, history }));
            }, [globals, stdData, reqData, presets, history]);

            const runReportCalculation = () => {
                 const resStd = calculateCharges(parseFloat(globals.cbm), parseFloat(globals.kgs), parseInt(globals.pkgs), stdData.sections, stdData.items);
                 const resReq = calculateCharges(parseFloat(globals.cbm), parseFloat(globals.kgs), parseInt(globals.pkgs), reqData.sections, reqData.items);
                 setHtmlOutput(generateReportHTML(resStd, resReq, globals.viewMode, stdData.title, reqData.title));
            };

            // Helper to pick which data object to modify based on active tab
            const getTargetData = (target) => (target === 'std' ? stdData : target === 'req' ? reqData : mgrData);
            const setTargetData = (target, newData) => {
                if (target === 'std') setStdData(newData);
                else if (target === 'req') setReqData(newData);
                else setMgrData(newData);
            };

            const updateSection = (target, idx, field, val) => {
                const prev = getTargetData(target);
                const newData = { ...prev, sections: [...prev.sections] };
                newData.sections[idx] = { ...newData.sections[idx], data: { ...newData.sections[idx].data, [field]: parseFloat(val) || val } };
                setTargetData(target, newData);
            };

            const addSection = (target, type) => {
                const prev = getTargetData(target);
                const newSec = { type, data: { curr: 'EUR', rt: 0, ton: 0, min: 0, heavy: 0, light: 0, high: 0, rate: 0, min_days: 0, days: 0, unit: 'RT' } };
                setTargetData(target, { ...prev, sections: [...prev.sections, newSec] });
            };

            const removeSection = (target, idx) => {
                const prev = getTargetData(target);
                setTargetData(target, { ...prev, sections: prev.sections.filter((_, i) => i !== idx) });
            };

            const updateItem = (target, idx, field, val) => {
                const prev = getTargetData(target);
                const newItems = [...prev.items];
                newItems[idx] = { ...newItems[idx], [field]: (field === 'price' || field === 'min_val') ? parseFloat(val) : val };
                setTargetData(target, { ...prev, items: newItems });
            };

            const addItem = (target) => {
                const prev = getTargetData(target);
                setTargetData(target, { ...prev, items: [...prev.items, { name: '', price: 0, unit: 'FLAT', curr: 'EUR', min_type: 'None', min_val: 0 }] });
            };

            const removeItem = (target, idx) => {
                const prev = getTargetData(target);
                setTargetData(target, { ...prev, items: prev.items.filter((_, i) => i !== idx) });
            };

            const loadPreset = (target, presetName) => {
                if(presets[presetName]) {
                    const copy = JSON.parse(JSON.stringify(presets[presetName]));
                    setTargetData(target, copy);
                }
            };

            // --- Manager Specific Handlers ---
            const handleMgrSelect = (val) => {
                setSelectedPresetName(val);
                if (val === 'Create New...') {
                    setMgrData({ sections: [], items: [], title: '' });
                } else if (presets[val]) {
                    setMgrData(JSON.parse(JSON.stringify(presets[val])));
                }
            };

            const handleSavePreset = () => {
                const name = mgrData.title.trim();
                if(!name) return alert("Please enter a Preset Name (Section Title).");
                setPresets(prev => ({ ...prev, [name]: mgrData }));
                setSelectedPresetName(name);
                alert(`Preset "${name}" saved.`);
            };

            const handleDeletePreset = () => {
                if(selectedPresetName === 'Create New...' || !presets[selectedPresetName]) return;
                if(!confirm(`Delete preset "${selectedPresetName}"?`)) return;
                const newPresets = { ...presets };
                delete newPresets[selectedPresetName];
                setPresets(newPresets);
                handleMgrSelect('Create New...');
            };
            
             const handleImportJSON = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const imported = JSON.parse(evt.target.result);
                        setPresets(prev => ({ ...prev, ...imported }));
                        alert("Presets imported successfully.");
                    } catch (err) { alert("Invalid JSON file."); }
                };
                reader.readAsText(file);
                e.target.value = ''; // Reset
            };

            const handleExportJSON = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(presets, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "dest_calc_presets.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };


            const saveSnapshot = () => {
                const resStd = calculateCharges(parseFloat(globals.cbm), parseFloat(globals.kgs), parseInt(globals.pkgs), stdData.sections, stdData.items);
                const resReq = calculateCharges(parseFloat(globals.cbm), parseFloat(globals.kgs), parseInt(globals.pkgs), reqData.sections, reqData.items);
                let summary = {};
                CURRENCIES.forEach(c => { if(resStd.totals[c] > 0 || resReq.totals[c] > 0) summary[c] = { std: resStd.totals[c], diff: resStd.totals[c] - resReq.totals[c] }; });
                const newHist = { id: Date.now(), timestamp: new Date().toLocaleTimeString(), ref: globals.ref || "No Ref", cbm: globals.cbm, summary, snap_std: stdData, snap_req: reqData };
                setHistory([newHist, ...history].slice(0, 50));
            };

            const loadHistory = (h) => {
                setGlobals(p => ({ ...p, ref: h.ref, cbm: h.cbm }));
                setStdData(h.snap_std);
                setReqData(h.snap_req);
            };

            const deleteHistory = (id) => { setHistory(history.filter(h => h.id !== id)); };

            const renderInputs = (target, data) => (
                <div className="space-y-4">
                    {/* Header & Preset Loader (Only show preset loader for std/req tabs, not mgr) */}
                    {target !== 'mgr' && (
                        <div className="flex gap-4 mb-4 bg-slate-50 p-3 rounded-lg border border-slate-200">
                            <input className="font-bold bg-transparent outline-none w-full" value={data.title} onChange={e => setTargetData(target, {...data, title: e.target.value})} placeholder="Section Title" />
                            <select onChange={(e) => loadPreset(target, e.target.value)} className="text-xs border rounded p-1">
                                <option>Load Preset...</option>
                                {Object.keys(presets).map(k => <option key={k} value={k}>{k}</option>)}
                            </select>
                        </div>
                    )}
                    
                    {/* Manager Specific Header */}
                    {target === 'mgr' && (
                         <div className="bg-amber-50 border border-amber-200 p-4 rounded-lg mb-4 space-y-3">
                            <div className="flex gap-4 items-center">
                                <div className="flex-1">
                                    <label className="block text-[10px] font-bold text-amber-700 uppercase mb-1">Select Preset to Edit</label>
                                    <select value={selectedPresetName} onChange={e => handleMgrSelect(e.target.value)} className="w-full text-sm border rounded p-1.5">
                                        <option>Create New...</option>
                                        {Object.keys(presets).map(k => <option key={k} value={k}>{k}</option>)}
                                    </select>
                                </div>
                                <div className="flex-1">
                                    <label className="block text-[10px] font-bold text-amber-700 uppercase mb-1">Preset Name</label>
                                    <input className="w-full text-sm border rounded p-1.5 font-bold" value={data.title} onChange={e => setTargetData(target, {...data, title: e.target.value})} placeholder="e.g. CLIENT A - STANDARD" />
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={handleSavePreset} className="bg-emerald-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-emerald-700 flex items-center gap-1"><Icons.Save size={14}/> Save Preset</button>
                                <button onClick={handleDeletePreset} className="bg-rose-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-rose-700 flex items-center gap-1"><Icons.Trash2 size={14}/> Delete</button>
                            </div>
                        </div>
                    )}

                    {/* Complex Sections */}
                    {data.sections.map((sec, idx) => (
                        <div key={idx} className="bg-white border border-slate-200 p-3 rounded-lg flex flex-wrap gap-2 items-end relative shadow-sm hover:shadow-md transition-shadow">
                            <div className="absolute top-1 right-1"><button onClick={() => removeSection(target, idx)} className="text-rose-400 hover:text-rose-600"><Icons.Trash2 size={14} /></button></div>
                            <span className="text-xs font-bold text-slate-400 w-12">{sec.type.toUpperCase()}</span>
                            <div className="flex flex-col"><label className="text-[10px] font-bold text-slate-400">CUR</label><select className="text-xs border rounded p-1" value={sec.data.curr} onChange={e => updateSection(target, idx, 'curr', e.target.value)}>{CURRENCIES.map(c => <option key={c}>{c}</option>)}</select></div>
                            {sec.type === 'lcl' && <>
                                <div className="flex flex-col"><label className="text-[10px] font-bold text-slate-400">CBM</label><input type="number" className="text-xs border rounded p-1 w-16" value={sec.data.rt} onChange={e => updateSection(target, idx, 'rt', e.target.value)} /></div>
                                <div className="flex flex-col"><label className="text-[10px] font-bold text-slate-400">TON</label><input type="number" className="text-xs border rounded p-1 w-16" value={sec.data.ton} onChange={e => updateSection(target, idx, 'ton', e.target.value)} /></div>
                            </>}
                            {sec.type === 'pier' && <>
                                <div className="flex flex-col"><label className="text-[10px] font-bold text-slate-400">HVY</label><input type="number" className="text-xs border rounded p-1 w-14" value={sec.data.heavy} onChange={e => updateSection(target, idx, 'heavy', e.target.value)} /></div>
                                <div className="flex flex-col"><label className="text-[10px] font-bold text-slate-400">LGT</label><input type="number" className="text-xs border rounded p-1 w-14" value={sec.data.light} onChange={e => updateSection(target, idx, 'light', e.target.value)} /></div>
                                <div className="flex flex-col"><label className="text-[10px] font-bold text-slate-400">HIGH</label><input type="number" className="text-xs border rounded p-1 w-14" value={sec.data.high} onChange={e => updateSection(target, idx, 'high', e.target.value)} /></div>
                            </>}
                            {sec.type === 'stor' && <>
                                <div className="flex flex-col"><label className="text-[10px] font-bold text-slate-400">RATE</label><input type="number" className="text-xs border rounded p-1 w-16" value={sec.data.rate} onChange={e => updateSection(target, idx, 'rate', e.target.value)} /></div>
                                <div className="flex flex-col"><label className="text-[10px] font-bold text-slate-400">MIN.D</label><input type="number" className="text-xs border rounded p-1 w-12" value={sec.data.min_days} onChange={e => updateSection(target, idx, 'min_days', e.target.value)} /></div>
                                <div className="flex flex-col"><label className="text-[10px] font-bold text-slate-400">DAYS</label><input type="number" className="text-xs border rounded p-1 w-12" value={sec.data.days} onChange={e => updateSection(target, idx, 'days', e.target.value)} /></div>
                            </>}
                            <div className="flex flex-col"><label className="text-[10px] font-bold text-slate-400">MIN</label><input type="number" className="text-xs border rounded p-1 w-14" value={sec.data.min} onChange={e => updateSection(target, idx, 'min', e.target.value)} /></div>
                        </div>
                    ))}
                    <div className="flex gap-2 text-xs">
                        <button onClick={() => addSection(target, 'lcl')} className="px-2 py-1 bg-slate-100 rounded hover:bg-slate-200">+ LCL</button>
                        <button onClick={() => addSection(target, 'pier')} className="px-2 py-1 bg-slate-100 rounded hover:bg-slate-200">+ Pier</button>
                        <button onClick={() => addSection(target, 'stor')} className="px-2 py-1 bg-slate-100 rounded hover:bg-slate-200">+ Stor</button>
                    </div>

                    {/* Line Items */}
                    <div className="mt-4">
                        <div className="text-[10px] font-bold text-slate-400 uppercase mb-2">Extra Items</div>
                        {data.items.map((item, idx) => (
                            <div key={idx} className="flex gap-1 mb-1 items-center flex-wrap sm:flex-nowrap">
                                <input className="text-xs border rounded p-1 w-full sm:w-auto sm:flex-grow" placeholder="Item Name" value={item.name} onChange={e => updateItem(target, idx, 'name', e.target.value)} />
                                <select className="text-xs border rounded p-1 w-14" value={item.curr} onChange={e => updateItem(target, idx, 'curr', e.target.value)}>{CURRENCIES.map(c => <option key={c}>{c}</option>)}</select>
                                <input className="text-xs border rounded p-1 w-16" type="number" placeholder="Price" value={item.price} onChange={e => updateItem(target, idx, 'price', e.target.value)} />
                                <select className="text-xs border rounded p-1 w-16" value={item.unit} onChange={e => updateItem(target, idx, 'unit', e.target.value)}>{['RT','BL','FLAT','PKG'].map(u => <option key={u}>{u}</option>)}</select>
                                
                                {/* RESTORED MINIMUM FIELDS */}
                                <select className="text-xs border rounded p-1 w-16" value={item.min_type || 'None'} onChange={e => updateItem(target, idx, 'min_type', e.target.value)}>
                                    <option value="None">-</option>
                                    <option value="Amt">Amt</option>
                                    <option value="Unit">Unit</option>
                                </select>
                                <input className="text-xs border rounded p-1 w-14" type="number" placeholder="Min" value={item.min_val || 0} onChange={e => updateItem(target, idx, 'min_val', e.target.value)} />

                                <button onClick={() => removeItem(target, idx)} className="text-rose-400 hover:text-rose-600"><Icons.Trash2 size={14} /></button>
                            </div>
                        ))}
                        <button onClick={() => addItem(target)} className="text-xs text-blue-600 hover:underline mt-1">+ Add Item</button>
                    </div>

                    {target === 'mgr' && (
                        <div className="mt-6 pt-6 border-t border-slate-200">
                             <h4 className="text-xs font-bold text-slate-500 uppercase mb-2">Advanced Tools</h4>
                             <div className="flex gap-2">
                                 <button onClick={handleExportJSON} className="bg-slate-100 border border-slate-300 text-slate-600 px-3 py-1.5 rounded text-xs font-bold hover:bg-slate-200 flex items-center gap-1"><Icons.Download size={14}/> Export JSON</button>
                                 <label className="bg-slate-100 border border-slate-300 text-slate-600 px-3 py-1.5 rounded text-xs font-bold hover:bg-slate-200 flex items-center gap-1 cursor-pointer">
                                     <Icons.Plus size={14}/> Import JSON
                                     <input type="file" accept=".json" onChange={handleImportJSON} className="hidden" />
                                 </label>
                             </div>
                        </div>
                    )}
                </div>
            );

            return (
                <div className="flex flex-col lg:flex-row gap-6 h-full">
                    {/* Main Work Area - Smooth width transition */}
                    <div className={`bg-white rounded-xl shadow-sm border border-slate-200 p-6 overflow-y-auto transition-width ${showSidebar ? 'lg:w-[calc(100%-19rem)]' : 'w-full'}`}>
                        {/* Global Inputs */}
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200 relative">
                            <div className="col-span-2 md:col-span-1"><label className="text-[10px] font-bold text-slate-400">JOB REF</label><input className="w-full text-sm border rounded p-1.5" value={globals.ref} onChange={e => setGlobals({...globals, ref: e.target.value})} placeholder="HMB-..." /></div>
                            <div><label className="text-[10px] font-bold text-slate-400">CBM</label><input type="number" className="w-full text-sm border rounded p-1.5 calc-input" value={globals.cbm} onChange={e => setGlobals({...globals, cbm: e.target.value})} /></div>
                            <div><label className="text-[10px] font-bold text-slate-400">KGS</label><input type="number" className="w-full text-sm border rounded p-1.5 calc-input" value={globals.kgs} onChange={e => setGlobals({...globals, kgs: e.target.value})} /></div>
                            <div><label className="text-[10px] font-bold text-slate-400">PKGS</label><input type="number" className="w-full text-sm border rounded p-1.5 calc-input" value={globals.pkgs} onChange={e => setGlobals({...globals, pkgs: e.target.value})} /></div>
                            <div className="flex items-end gap-2">
                                <button onClick={saveSnapshot} className="flex-1 bg-blue-600 text-white text-xs font-bold py-2 rounded hover:bg-blue-700 transition-colors"> SNAP</button>
                                <button onClick={() => setShowSidebar(!showSidebar)} className={`w-8 h-8 flex items-center justify-center rounded border transition-colors ${showSidebar ? 'bg-blue-50 border-blue-200 text-blue-600' : 'bg-white border-slate-200 text-slate-400 hover:text-slate-600'}`} title={showSidebar ? "Hide History" : "Show History"}>
                                    <Icons.Scroll size={16} />
                                </button>
                            </div>
                        </div>

                        {/* Editor Tabs */}
                        <div className="flex gap-2 mb-4 border-b border-slate-200 pb-2 overflow-x-auto">
                            <button onClick={() => setActiveSubTab('std')} className={`px-4 py-1.5 text-sm font-bold rounded-lg transition-colors whitespace-nowrap ${activeSubTab==='std' ? 'bg-slate-800 text-white' : 'text-slate-500 hover:bg-slate-100'}`}>Standard</button>
                            <button onClick={() => setActiveSubTab('req')} className={`px-4 py-1.5 text-sm font-bold rounded-lg transition-colors whitespace-nowrap ${activeSubTab==='req' ? 'bg-slate-800 text-white' : 'text-slate-500 hover:bg-slate-100'}`}>Requested</button>
                            <button onClick={() => setActiveSubTab('mgr')} className={`px-4 py-1.5 text-sm font-bold rounded-lg transition-colors whitespace-nowrap ${activeSubTab==='mgr' ? 'bg-amber-600 text-white shadow-sm' : 'text-amber-600 bg-amber-50 hover:bg-amber-100'}`}>Manage Presets</button>
                        </div>

                        {/* Editor Content */}
                        <div className="mb-8">
                            {activeSubTab === 'std' && renderInputs('std', stdData)}
                            {activeSubTab === 'req' && renderInputs('req', reqData)}
                            {activeSubTab === 'mgr' && renderInputs('mgr', mgrData)}
                        </div>

                        {/* Output Controls (Hide in Manager Mode) */}
                        {activeSubTab !== 'mgr' && (
                            <>
                                <div className="flex justify-between items-center border-t border-slate-200 pt-4 mb-4">
                                    <select value={globals.viewMode} onChange={e => setGlobals({...globals, viewMode: e.target.value})} className="text-sm font-bold border rounded p-2">
                                        <option value="Comparison">Comparison View</option>
                                        <option value="Standard">Standard Only</option>
                                        <option value="Requested">Requested Only</option>
                                    </select>
                                    <button onClick={runReportCalculation} className="bg-emerald-500 text-white font-bold text-sm px-4 py-2 rounded hover:bg-emerald-600 transition-colors shadow-sm">GENERATE REPORT</button>
                                </div>
                                <div className="bg-slate-100 p-4 rounded-lg border border-slate-200 min-h-[300px]" dangerouslySetInnerHTML={{__html: htmlOutput}}></div>
                            </>
                        )}
                    </div>

                    {/* History Sidebar - Conditional Rendering with explicit width */}
                    {showSidebar && (
                        <div className="w-full lg:w-72 bg-white rounded-xl shadow-sm border border-slate-200 p-4 flex flex-col h-[600px] lg:h-auto animate-fade shrink-0">
                            <div className="flex justify-between items-center mb-4">
                                <h4 className="font-bold text-slate-700">Local History</h4>
                                <button onClick={() => setHistory([])} className="text-[10px] text-slate-400 hover:text-rose-500">Clear All</button>
                            </div>
                            <div className="overflow-y-auto flex-grow space-y-2 pr-1">
                                {history.length === 0 && <div className="text-center text-slate-400 text-xs mt-10">No snapshots yet.</div>}
                                {history.map(h => (
                                    <div key={h.id} onClick={() => loadHistory(h)} className="bg-slate-50 border border-slate-100 p-3 rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-200 group relative transition-all">
                                        <button onClick={(e) => {e.stopPropagation(); deleteHistory(h.id);}} className="absolute top-2 right-2 text-slate-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icons.Trash2 size={14} /></button>
                                        <div className="font-bold text-xs text-blue-600 mb-1">{h.ref}</div>
                                        <div className="text-[10px] text-slate-400 mb-2">{h.timestamp} | {h.cbm} m</div>
                                        {Object.entries(h.summary).map(([curr, val]) => (
                                            <div key={curr} className="flex justify-between text-[10px]">
                                                <span className="text-slate-600">{curr} {val.std.toFixed(2)}</span>
                                                <span className={val.diff >= 0 ? 'text-rose-500 font-bold' : 'text-emerald-500 font-bold'}>
                                                    {val.diff >= 0 ? '+' : ''}{val.diff.toFixed(2)}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const VesselScheduleApp = () => {
            const [mainTab, setMainTab] = useState('vessel');
            const [vesselSubTab, setVesselSubTab] = useState('schedule'); // schedule | builder

            // ... (All existing main app logic remains same)
            const [entries, setEntries] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isAdmin, setIsAdmin] = useState(false);
            const [user, setUser] = useState(null);
            const [authErrorMsg, setAuthErrorMsg] = useState(null);
            const [activeScheduleFilter, setActiveScheduleFilter] = useState('ALL');
            const [selectedEntryId, setSelectedEntryId] = useState(null);
            const [selectedForText, setSelectedForText] = useState(new Set());
            const [selectionDestCode, setSelectionDestCode] = useState(null);
            const [editingId, setEditingId] = useState(null);
            const [adminSearchTerm, setAdminSearchTerm] = useState('');
            const [adminSortBy, setAdminSortBy] = useState('etd'); 
            const formTopRef = useRef(null);
            const [formData, setFormData] = useState({ vessel: '', voyage: '', cfsClosing: '', etdHkg: '', etaDest: '', destCode: 'HAM', loadingDate: '', carrier: '', transitTime: '' });
            const [displayConfig, setDisplayConfig] = useState({ showVesselLine: true, showCarrier: true, showCfs: true, showLoad: true, showEtd: true, showEta: true, showTt: true });
            const [generatedText, setGeneratedText] = useState('');
            const [copied, setCopied] = useState(false);

            useEffect(() => {
                const unsubscribe = window.onAuthStateChanged(window.auth, async (currentUser) => {
                    setUser(currentUser);
                    setAuthErrorMsg(null);
                    if (currentUser) {
                        if (currentUser.isAnonymous) {
                            setIsAdmin(false); 
                            setMainTab('vessel');
                            setVesselSubTab('schedule');
                        } else {
                            try {
                                const configRef = window.doc(window.db, 'config', 'admin');
                                const configSnap = await window.getDoc(configRef);
                                if (configSnap.exists()) {
                                    const allowed = configSnap.data().allowedEmails || [];
                                    const userEmailLower = currentUser.email.trim().toLowerCase();
                                    const allowedLower = allowed.map(e => e.trim().toLowerCase());
                                    if (allowedLower.includes(userEmailLower)) { 
                                        setIsAdmin(true); 
                                        setMainTab('vessel');
                                        setVesselSubTab('builder'); 
                                    } 
                                    else { setIsAdmin(false); setAuthErrorMsg(`Email '${currentUser.email}' is not in the allowed list.`); }
                                } else { setAuthErrorMsg("Config document missing."); setIsAdmin(false); }
                            } catch (e) { setIsAdmin(false); setAuthErrorMsg("Permission Denied."); }
                        }
                    } else {
                        try { await window.signInAnonymously(window.auth); } catch (e) {}
                        setIsAdmin(false); 
                        setMainTab('vessel');
                        setVesselSubTab('schedule');
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (window.db && user) {
                    const unsub = window.onSnapshot(
                        window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'vessel_schedules'),
                        (snapshot) => { setEntries(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); setLoading(false); },
                        (error) => { console.error(error); setLoading(false); }
                    );
                    return () => unsub();
                }
            }, [user]);

            const handleGoogleLogin = async () => { try { await window.signInWithPopup(window.auth, window.googleProvider); } catch (error) { alert("Login failed"); } };
            const handleLogout = async () => { await window.signOut(window.auth); await window.signInAnonymously(window.auth); setIsAdmin(false); setAuthErrorMsg(null); setMainTab('vessel'); setVesselSubTab('schedule'); };

            // ... (Keep all existing handler functions: handleEdit, saveEntry, removeEntry, etc. exactly as they were)
            const handleEdit = (entry) => { setFormData({ vessel: entry.vessel||'', voyage: entry.voyage||'', cfsClosing: entry.cfsClosing||'', etdHkg: entry.etdHkg||'', etaDest: entry.etaDest||'', destCode: entry.destCode||'', loadingDate: entry.loadingDate||'', carrier: entry.carrier||'', transitTime: entry.transitTime||'' }); setEditingId(entry.id); if(formTopRef.current) formTopRef.current.scrollIntoView({behavior:'smooth'}); };
            const cancelEditing = () => { setEditingId(null); setFormData({ vessel: '', voyage: '', cfsClosing: '', etdHkg: '', etaDest: '', destCode: 'HAM', loadingDate: '', carrier: '', transitTime: '' }); };
            const saveEntry = async (e) => { e.preventDefault(); if(!formData.vessel) return; if(!isAdmin) return alert("Access denied."); if(editingId) { await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'vessel_schedules', editingId), {...formData, updatedAt: new Date().toISOString()}); } else { await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'vessel_schedules'), {...formData, createdAt: new Date().toISOString()}); } setEditingId(null); setFormData({ vessel: '', voyage: '', cfsClosing: '', etdHkg: '', etaDest: '', destCode: formData.destCode, loadingDate: '', carrier: '', transitTime: '' }); };
            const removeEntry = async (id) => { if(!isAdmin) return alert("Access denied."); await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'vessel_schedules', id)); if(selectedEntryId===id) setSelectedEntryId(null); if(editingId===id) cancelEditing(); if(selectedForText.has(id)){ const newSet=new Set(selectedForText); newSet.delete(id); setSelectedForText(newSet); if(newSet.size===0) setSelectionDestCode(null); } };
            const getWeekNumber = (dStr) => { if (!dStr) return ''; const d = new Date(dStr); d.setHours(0,0,0,0); d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7); const w1 = new Date(d.getFullYear(), 0, 4); return 1 + Math.round(((d.getTime() - w1.getTime()) / 86400000 - 3 + (w1.getDay() + 6) % 7) / 7); };
            const formatDate = (s) => { if (!s) return ''; const [y, m, d] = s.split('-'); return new Date(y, m-1, d).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }).toUpperCase().replace(/ /g, '-'); };
            const handleInputChange = (e) => { let { name, value } = e.target; if (name === 'destCode') value = value.toUpperCase(); setFormData(prev => { const upd = { ...prev, [name]: value }; if (name === 'etdHkg' || name === 'etaDest') { const start = name === 'etdHkg' ? value : prev.etdHkg; const end = name === 'etaDest' ? value : prev.etaDest; if (start && end) { const diffDays = Math.round((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24)); if (!isNaN(diffDays)) upd.transitTime = diffDays.toString(); } } return upd; }); };
            const toggleSelection = (entry) => { const newSet = new Set(selectedForText); if (!newSet.has(entry.id)) { if (newSet.size > 0 && entry.destCode !== selectionDestCode) { alert(`Only select schedules for ${selectionDestCode}`); return; } if (newSet.size === 0) setSelectionDestCode(entry.destCode); newSet.add(entry.id); } else { newSet.delete(entry.id); if (newSet.size === 0) setSelectionDestCode(null); } setSelectedForText(newSet); };
            const copyToClipboard = () => { if (navigator.clipboard) { navigator.clipboard.writeText(generatedText); setCopied(true); setTimeout(() => setCopied(false), 2000); } };

            const today = new Date(); const pastDate = new Date(today); pastDate.setDate(today.getDate() - 21);
            const cutoffDate = `${pastDate.getFullYear()}-${String(pastDate.getMonth()+1).padStart(2,'0')}-${String(pastDate.getDate()).padStart(2,'0')}`;
            const visibleEntries = entries.filter(e => !e.cfsClosing || e.cfsClosing >= cutoffDate);
            const adminFilteredEntries = visibleEntries.filter(entry => { if (!adminSearchTerm) return true; const term = adminSearchTerm.toLowerCase(); return ((entry.vessel||'').toLowerCase().includes(term) || (entry.voyage||'').toLowerCase().includes(term) || (entry.destCode||'').toLowerCase().includes(term)); }).sort((a, b) => { if (adminSortBy === 'vessel') return (a.vessel||'').localeCompare(b.vessel||''); if (adminSortBy === 'pod') return (a.destCode||'').localeCompare(b.destCode||''); return new Date(a.etdHkg||0) - new Date(b.etdHkg||0); });
            const uniqueDestinations = [...new Set(visibleEntries.map(e => e.destCode))].filter(Boolean).sort();
            const filteredEntries = visibleEntries.filter(e => activeScheduleFilter === 'ALL' || e.destCode === activeScheduleFilter).sort((a, b) => new Date(a.etdHkg||0) - new Date(b.etdHkg||0));
            const selectedEntry = entries.find(e => e.id === selectedEntryId);

            useEffect(() => {
                let src = selectedForText.size > 0 ? entries.filter(e => selectedForText.has(e.id)) : [...visibleEntries]; 
                src.sort((a, b) => new Date(a.etdHkg||0) - new Date(b.etdHkg||0));
                const txt = src.map((e, i) => {
                    let b = []; b.push(displayConfig.showVesselLine ? `${i + 1}) M/V: ${e.vessel}${e.voyage ? ' / ' + e.voyage : ''}` : `${i + 1})`);
                    if (displayConfig.showCarrier && e.carrier) b.push(`CARRIER: ${e.carrier}`); if (displayConfig.showCfs && e.cfsClosing) b.push(`CFS CLOSING: ${formatDate(e.cfsClosing)}`); if (displayConfig.showLoad && e.loadingDate) b.push(`LOAD: ${formatDate(e.loadingDate)}`); if (displayConfig.showEtd && e.etdHkg) b.push(`ETD HKG: ${formatDate(e.etdHkg)}`); if (displayConfig.showEta && e.etaDest) b.push(`ETA ${e.destCode}: ${formatDate(e.etaDest)}`); if (displayConfig.showTt && e.transitTime) b.push(`TT: ${e.transitTime} DAYS`);
                    return b.join('\n');
                }).join('\n\n');
                setGeneratedText(txt);
            }, [entries, visibleEntries, displayConfig, selectedForText]);

            return (
                <div className="min-h-screen flex flex-col font-sans">
                    <nav className="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 text-white shadow-lg sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16 items-center">
                                <div className="flex items-center gap-3">
                                    <div className="bg-white/10 p-2 rounded-lg backdrop-blur-sm border border-white/10"><Icons.Ship size={24} className="text-blue-300" /></div>
                                    <div><h1 className="font-bold text-lg tracking-tight leading-tight">VesselManager</h1><p className="text-[10px] text-slate-400 font-medium tracking-wider uppercase">Logistics Dashboard</p></div>
                                </div>
                                
                                {/* MAIN NAV TABS */}
                                <div className="hidden md:flex gap-1 bg-slate-800/50 p-1 rounded-lg border border-white/5 mx-6">
                                    <button onClick={() => setMainTab('vessel')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${mainTab === 'vessel' ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}>Vessel Schedule</button>
                                    <button onClick={() => setMainTab('calculator')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${mainTab === 'calculator' ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}>Dest Calculator</button>
                                </div>

                                <div className="flex items-center gap-6">
                                    <div className="h-6 w-px bg-white/10 hidden sm:block"></div>
                                    {(user && !user.isAnonymous) ? (
                                        <div className="flex items-center gap-3">
                                            {isAdmin ? ( <span className="flex items-center gap-2 text-xs font-semibold text-emerald-400 bg-emerald-900/30 px-2 py-1 rounded border border-emerald-800 cursor-help" title="Admin Access"><Icons.CheckCircle size={12}/> Admin</span> ) : ( <span className="flex items-center gap-2 text-xs font-semibold text-slate-400 bg-slate-800/50 px-2 py-1 rounded border border-slate-700 cursor-pointer hover:bg-slate-700" onClick={() => alert(authErrorMsg || "Visitor Mode")}><Icons.User size={12}/> Visitor</span> )}
                                            <button onClick={handleLogout} className="text-xs text-rose-300 hover:text-rose-100 hover:underline">Sign Out</button>
                                        </div>
                                    ) : ( <button onClick={handleGoogleLogin} className="flex items-center gap-2 text-xs font-bold text-slate-900 bg-white hover:bg-slate-100 px-3 py-2 rounded-lg transition-colors shadow-sm"><Icons.Google size={14} /> Admin Login</button> )}
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full">
                        {loading ? ( <div className="flex flex-col items-center justify-center p-12 space-y-4"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div><p className="text-slate-400 text-sm animate-pulse">Syncing data...</p></div> ) : (
                            <>
                                {mainTab === 'calculator' && (
                                    <div className="animate-fade">
                                        <DestCalcTool />
                                    </div>
                                )}

                                {mainTab === 'vessel' && (
                                    <>
                                        {/* Sub-nav for Vessel Manager (Only for Admin to toggle Builder) */}
                                        {isAdmin && (
                                            <div className="flex gap-2 mb-6 border-b border-slate-200 pb-2">
                                                 <button onClick={() => setVesselSubTab('schedule')} className={`flex items-center gap-2 px-4 py-2 text-sm font-bold rounded-lg transition-colors ${vesselSubTab === 'schedule' ? 'bg-slate-800 text-white' : 'text-slate-500 hover:bg-slate-100'}`}><Icons.Table size={16}/> View Schedule</button>
                                                 <button onClick={() => setVesselSubTab('builder')} className={`flex items-center gap-2 px-4 py-2 text-sm font-bold rounded-lg transition-colors ${vesselSubTab === 'builder' ? 'bg-slate-800 text-white' : 'text-slate-500 hover:bg-slate-100'}`}><Icons.LayoutList size={16}/> Schedule Builder</button>
                                            </div>
                                        )}

                                        {vesselSubTab === 'builder' && isAdmin && (
                                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-fade">
                                                <div className="lg:col-span-7 space-y-8">
                                                    <div ref={formTopRef} className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
                                                        <div className="bg-slate-50/50 px-6 py-4 border-b border-slate-200 flex items-center gap-3"><div className={`p-2 rounded-full ${editingId ? 'bg-blue-100 text-blue-600' : 'bg-blue-100 text-blue-600'}`}>{editingId ? <Icons.Edit size={18} /> : <Icons.Plus size={18} />}</div><h2 className={`font-bold ${editingId ? 'text-blue-600' : 'text-slate-800'}`}>{editingId ? 'Edit Vessel' : 'New Vessel Entry'}</h2></div>
                                                        <form onSubmit={saveEntry} className="p-6 space-y-6">
                                                            <div className="space-y-4"><h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">Vessel Identification</h3><div className="grid grid-cols-2 gap-4"><InputField label="Vessel Name" name="vessel" value={formData.vessel} onChange={handleInputChange} placeholder="e.g. EVER ALP" required className="col-span-2 md:col-span-1" /><InputField label="Voyage #" name="voyage" value={formData.voyage} onChange={handleInputChange} placeholder="e.g. 1377-015W" className="col-span-2 md:col-span-1" /><InputField label="Carrier" name="carrier" value={formData.carrier} onChange={handleInputChange} placeholder="e.g. COSCO" className="col-span-2" /></div></div>
                                                            <div className="space-y-4"><h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">Logistics Dates</h3><div className="grid grid-cols-2 md:grid-cols-3 gap-4"><SmartDateInput label="CFS Closing" name="cfsClosing" value={formData.cfsClosing} onChange={handleInputChange} /><SmartDateInput label="Loading Date" name="loadingDate" value={formData.loadingDate} onChange={handleInputChange} /><SmartDateInput label="ETD HKG" name="etdHkg" value={formData.etdHkg} onChange={handleInputChange} /></div></div>
                                                            <div className="space-y-4"><h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">Route & Transit</h3><div className="grid grid-cols-2 md:grid-cols-3 gap-4"><SmartDateInput label="ETA Dest" name="etaDest" value={formData.etaDest} onChange={handleInputChange} /><InputField label="POD Code" name="destCode" value={formData.destCode} onChange={handleInputChange} placeholder="HAM" /><InputField label="TT (Days)" name="transitTime" type="number" value={formData.transitTime} onChange={handleInputChange} placeholder="42" /></div></div>
                                                            <div className="pt-4 border-t border-slate-100 flex gap-3"><button type="submit" className="flex-grow bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-blue-200 transition-all flex items-center justify-center gap-2 transform active:scale-95">{editingId ? <><Icons.Edit size={20} /> Update Schedule</> : <><Icons.Plus size={20} /> Add to Schedule</>}</button>{editingId && <button type="button" onClick={cancelEditing} className="px-6 py-3 rounded-xl border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition-colors">Cancel</button>}</div>
                                                        </form>
                                                    </div>
                                                    {visibleEntries.length > 0 && <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><div className="bg-slate-50/50 px-6 py-4 border-b border-slate-200 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><h2 className="font-bold text-slate-800">Quick Edit</h2><div className="flex flex-wrap items-center gap-2 w-full sm:w-auto"><div className="relative"><input type="text" placeholder="Search..." value={adminSearchTerm} onChange={e => setAdminSearchTerm(e.target.value)} className="pl-8 pr-3 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none w-full sm:w-48 transition-all" /><div className="absolute left-2.5 top-1.5 text-slate-400"><Icons.Search size={14} /></div></div><select value={adminSortBy} onChange={e => setAdminSortBy(e.target.value)} className="px-2 py-1.5 text-xs border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer"><option value="etd">Sort: ETD</option><option value="vessel">Sort: Name</option><option value="pod">Sort: POD</option></select>{selectedForText.size > 0 && <button onClick={() => {setSelectedForText(new Set()); setSelectionDestCode(null);}} className="text-xs bg-rose-50 text-rose-600 px-3 py-1.5 rounded-lg font-medium hover:bg-rose-100 transition-colors">Clear ({selectedForText.size})</button>}</div></div><div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-slate-50 text-slate-500 font-semibold uppercase text-xs tracking-wider"><tr><th className="px-4 py-3 w-8 text-center">Select</th><th className="px-4 py-3">Vessel</th><th className="px-4 py-3">ETD</th><th className="px-4 py-3">POD</th><th className="px-4 py-3">ETA</th><th className="px-4 py-3 text-right">Action</th></tr></thead><tbody className="divide-y divide-slate-100">{adminFilteredEntries.length === 0 ? <tr><td colSpan={6} className="p-8 text-center text-slate-400 italic">No matches found.</td></tr> : adminFilteredEntries.map((entry) => { const isSelected = selectedForText.has(entry.id); const isDisabled = selectionDestCode && entry.destCode !== selectionDestCode && !isSelected; const isEditing = editingId === entry.id; return (<tr key={entry.id} className={`group transition-all ${isSelected ? 'bg-blue-50/60' : 'hover:bg-slate-50'} ${isDisabled ? 'opacity-40 grayscale' : ''} ${isEditing ? 'bg-blue-50/30' : ''}`}><td className="px-4 py-4 text-center"><button onClick={() => toggleSelection(entry)} disabled={isDisabled} className={`w-5 h-5 rounded-md border flex items-center justify-center transition-all ${isSelected ? 'bg-blue-600 border-blue-600 text-white scale-110 shadow-sm' : 'border-slate-300 text-transparent hover:border-blue-400'}`}><Icons.CheckCircle size={14} /></button></td><td className="px-4 py-4"><div className="font-bold text-slate-800">{entry.vessel}</div><div className="text-xs text-slate-500 font-mono mt-0.5">{entry.voyage}</div></td><td className="px-4 py-4 text-slate-600 font-medium text-xs whitespace-nowrap">{formatDate(entry.etdHkg)}</td><td className="px-4 py-4 text-slate-600 font-bold text-xs">{entry.destCode}</td><td className="px-4 py-4 text-slate-600 font-medium text-xs whitespace-nowrap">{formatDate(entry.etaDest)}</td><td className="px-4 py-4 text-right"><div className="flex justify-end gap-2"><button onClick={() => handleEdit(entry)} className="text-slate-300 hover:text-blue-500 p-2 rounded-lg hover:bg-blue-50 transition-all"><Icons.Edit size={18}/></button><button onClick={() => removeEntry(entry.id)} className="text-slate-300 hover:text-rose-500 p-2 rounded-lg hover:bg-rose-50 transition-all"><Icons.Trash2 size={18} /></button></div></td></tr>); })}</tbody></table></div></div>}
                                                </div>
                                                <div className="lg:col-span-5 space-y-6">
                                                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6"><div className="flex items-center gap-2 mb-4 text-slate-800"><Icons.Settings size={20} className="text-blue-600" /><h3 className="font-bold">Output Config</h3></div><div className="flex flex-wrap gap-2">{['showVesselLine:Vessel', 'showCarrier:Carrier', 'showEtd:ETD', 'showEta:ETA', 'showCfs:CFS', 'showLoad:Load', 'showTt:TT'].map(opt => { const [key, label] = opt.split(':'); return (<button key={key} onClick={() => setDisplayConfig(p => ({...p, [key]: !p[key]}))} className={`px-3 py-1.5 text-xs font-semibold rounded-lg border transition-all ${displayConfig[key] ? 'bg-blue-50 border-blue-200 text-blue-700 shadow-sm' : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'}`}>{label}</button>) })}</div></div>
                                                    <div className="bg-slate-900 rounded-2xl shadow-xl border border-slate-800 overflow-hidden flex flex-col h-[500px]"><div className="bg-slate-950 px-5 py-4 flex justify-between items-center border-b border-slate-800"><span className="font-mono text-xs text-blue-400 font-bold uppercase tracking-wider flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div> Output Preview</span><button onClick={copyToClipboard} className={`text-xs font-bold px-3 py-1.5 rounded-lg transition-all ${copied ? 'bg-emerald-500 text-white' : 'bg-blue-600 text-white hover:bg-blue-500'}`}>{copied ? 'COPIED!' : 'COPY TEXT'}</button></div><div className="relative flex-grow bg-slate-900"><textarea readOnly value={generatedText} className="w-full h-full bg-transparent p-6 text-slate-300 font-mono text-xs leading-relaxed focus:outline-none resize-none relative z-10" />{generatedText === '' && <div className="absolute inset-0 flex items-center justify-center text-slate-700 text-sm font-mono z-0">Ready for data...</div>}</div></div>
                                                </div>
                                            </div>
                                        )}

                                        {vesselSubTab === 'schedule' && (
                                            <div className="space-y-8 animate-fade pb-12">
                                                <div className="flex items-center gap-2 overflow-x-auto pb-4 scrollbar-hide"><button onClick={() => { setActiveScheduleFilter('ALL'); setSelectedEntryId(null); }} className={`flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-bold transition-all shadow-sm border ${activeScheduleFilter === 'ALL' ? 'bg-slate-800 text-white border-slate-800 ring-2 ring-slate-200' : 'bg-white text-slate-600 border-slate-200 hover:border-blue-300 hover:text-blue-600'}`}><span>All Ports</span> <span className={`px-1.5 py-0.5 rounded-md text-[10px] ${activeScheduleFilter === 'ALL' ? 'bg-white/20 text-white' : 'bg-slate-100 text-slate-500'}`}>{visibleEntries.length}</span></button><div className="w-px h-8 bg-slate-200 mx-2"></div>{uniqueDestinations.map(dest => (<button key={dest} onClick={() => { setActiveScheduleFilter(dest); setSelectedEntryId(null); }} className={`flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-bold transition-all shadow-sm border ${activeScheduleFilter === dest ? 'bg-blue-600 text-white border-blue-600 ring-2 ring-blue-100' : 'bg-white text-slate-600 border-slate-200 hover:border-blue-300 hover:text-blue-600'}`}><Icons.MapPin size={16} className={activeScheduleFilter === dest ? 'text-white' : 'text-slate-400'} /> <span>{dest}</span> </button>))}</div>
                                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><div className="overflow-x-auto"><table className="w-full"><thead><tr className="bg-slate-50 border-b border-slate-200 text-xs uppercase tracking-wider text-slate-500 font-bold"><th className="px-6 py-4 w-20 text-center bg-slate-100/50">Wk</th><th className="px-6 py-4 text-left">Vessel / Voyage</th><th className="px-6 py-4 text-left">Closing</th>{isAdmin && <th className="px-6 py-4 text-left">Load</th>}<th className="px-6 py-4 text-left">ETD HKG</th><th className="px-6 py-4 text-left">{activeScheduleFilter === 'ALL' ? 'ETA / POD' : `ETA ${activeScheduleFilter}`}</th><th className="px-6 py-4 text-left">Carrier</th><th className="px-6 py-4 text-center">T.T</th>{isAdmin && <th className="px-6 py-4 w-10"></th>}</tr></thead><tbody className="divide-y divide-slate-100 text-sm font-medium">{filteredEntries.length === 0 ? <tr><td colSpan={isAdmin ? 8 : 7} className="p-16 text-center text-slate-400 italic">No recent schedules found.</td></tr> : filteredEntries.map((entry) => (<tr key={entry.id} onClick={() => setSelectedEntryId(entry.id)} className={`group cursor-pointer transition-all hover:bg-slate-50 ${selectedEntryId === entry.id ? 'bg-blue-50/60 border-l-4 border-l-blue-600' : 'border-l-4 border-l-transparent'}`}><td className="px-6 py-4 text-center"><span className="text-slate-400 text-xs">#</span>{getWeekNumber(entry.etdHkg)}</td><td className="px-6 py-4"><div className="font-bold text-slate-800 text-base">{entry.vessel}</div><div className="text-xs text-slate-500 font-mono mt-1 bg-slate-100 inline-block px-1.5 py-0.5 rounded">{entry.voyage}</div></td><td className="px-6 py-4 text-slate-600 tabular-nums">{formatDate(entry.cfsClosing)}</td>{isAdmin && <td className="px-6 py-4 text-slate-600 tabular-nums">{formatDate(entry.loadingDate)}</td>}<td className="px-6 py-4 text-blue-700 font-bold tabular-nums">{formatDate(entry.etdHkg)}</td><td className="px-6 py-4"><div className="flex items-center gap-2"><span className="tabular-nums text-slate-700">{formatDate(entry.etaDest)}</span>{activeScheduleFilter === 'ALL' && <span className="text-[10px] font-bold bg-slate-200 text-slate-700 px-1.5 py-0.5 rounded">{entry.destCode}</span>}</div></td><td className="px-6 py-4"><span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-indigo-50 text-indigo-700 border border-indigo-100">{entry.carrier}</span></td><td className="px-6 py-4 text-center"><span className="text-slate-600 font-bold bg-slate-100 px-2 py-1 rounded-md">{entry.transitTime}</span></td>{isAdmin && (<td className="px-6 py-4 text-center"><button onClick={(e) => {e.stopPropagation(); removeEntry(entry.id);}} className="text-slate-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icons.Trash2 size={18}/></button></td>)}</tr>))}</tbody></table></div></div>
                                                <div className="pt-4"><CalendarWidget entry={selectedEntry} isAdmin={isAdmin} /></div>
                                            </div>
                                        )}
                                    </>
                                )}
                            </>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<VesselScheduleApp />);
    </script>
</body>
</html>
